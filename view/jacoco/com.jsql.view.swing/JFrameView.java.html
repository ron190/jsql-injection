<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JFrameView.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">view</a> &gt; <a href="index.source.html" class="el_package">com.jsql.view.swing</a> &gt; <span class="el_source">JFrameView.java</span></div><h1>JFrameView.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Copyhacked (H) 2012-2025.
 * This program and the accompanying materials
 * are made available under no term at all, use it like
 * you want, but share and discuss it
 * every time possible with every body.
 * 
 * Contributors:
 *      ron190 at ymail dot com - initial implementation
 ******************************************************************************/
package com.jsql.view.swing;

import com.jsql.model.InjectionModel;
import com.jsql.util.*;
import com.jsql.view.interaction.SubscriberInteraction;
import com.jsql.view.swing.action.HotkeyUtil;
import com.jsql.view.swing.menubar.AppMenubar;
import com.jsql.view.swing.panel.PanelAddressBar;
import com.jsql.view.swing.panel.split.SplitNS;
import com.jsql.view.swing.terminal.AbstractExploit;
import com.jsql.view.swing.tab.TabManagers;
import com.jsql.view.swing.util.MediatorHelper;
import com.jsql.view.swing.util.UiUtil;
import org.apache.commons.lang3.SystemUtils;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

import javax.swing.*;
import java.awt.*;
import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;
import java.util.prefs.Preferences;
import java.util.stream.Stream;

/**
 * View in the MVC pattern, defines all the components
 * and process actions sent by the model.&lt;br&gt;
 * Main groups of components:&lt;br&gt;
 * - at the top: textfield inputs,&lt;br&gt;
 * - at the center: tree on the left, table on the right,&lt;br&gt;
 * - at the bottom: information labels.
 */
public class JFrameView extends JFrame {

<span class="fc" id="L48">    private static final Logger LOGGER = LogManager.getRootLogger();</span>

    /**
     * Map of terminal by unique identifier.
     */
<span class="fc" id="L53">    private final Map&lt;UUID, AbstractExploit&gt; mapUuidShell = new HashMap&lt;&gt;();</span>
<span class="fc" id="L54">    private final transient SubscriberInteraction subscriber = new SubscriberInteraction(&quot;com.jsql.view.swing.interaction&quot;);</span>
    private TabManagers tabManagers;
<span class="fc" id="L56">    private boolean isMaximized = false;</span>
    private final InjectionModel injectionModel;
    private SplitNS splitNS;  // main

    public JFrameView(InjectionModel injectionModel) {  // Build the GUI: add app icon, tree icons, the 3 main panels
<span class="fc" id="L61">        super(StringUtil.APP_NAME);</span>
<span class="fc" id="L62">        this.injectionModel = injectionModel;</span>
<span class="fc" id="L63">        MediatorHelper.register(this);</span>
<span class="fc" id="L64">        UiUtil.prepareGUI();  // Load UI before any component</span>
<span class="fc" id="L65">        this.initPaneComponents();</span>
<span class="fc" id="L66">        this.initWindow();</span>
<span class="fc" id="L67">        this.initShortcuts();</span>
<span class="fc" id="L68">        this.displayVersion();</span>
<span class="fc" id="L69">        I18nUtil.checkCurrentLanguage();</span>
<span class="fc" id="L70">        this.check4K();</span>

<span class="fc" id="L72">        SwingUtilities.invokeLater(() -&gt; {  // paint native blu svg in theme color behind the scene</span>
<span class="fc" id="L73">            AppMenubar.applyTheme(injectionModel.getMediatorUtils().getPreferencesUtil().getThemeFlatLafName());  // refresh missing components</span>
<span class="pc bpc" id="L74" title="1 of 2 branches missed.">            if (injectionModel.getMediatorUtils().getProxyUtil().isNotLive(GitUtil.ShowOnConsole.YES)) {  // network access</span>
<span class="nc" id="L75">                return;</span>
            }
<span class="pc bpc" id="L77" title="1 of 2 branches missed.">            if (injectionModel.getMediatorUtils().getPreferencesUtil().isCheckingUpdate()) {</span>
<span class="nc" id="L78">                injectionModel.getMediatorUtils().getGitUtil().checkUpdate(GitUtil.ShowOnConsole.NO);</span>
            }
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">            if (injectionModel.getMediatorUtils().getPreferencesUtil().isShowNews()) {  // disabled when UT only</span>
<span class="nc" id="L81">                injectionModel.getMediatorUtils().getGitUtil().showNews();</span>
            }
<span class="fc" id="L83">            this.setVisible(true);</span>
<span class="fc" id="L84">            MediatorHelper.panelAddressBar().getTextFieldAddress().requestFocusInWindow();  // required here to get focus</span>
<span class="fc" id="L85">        });</span>
<span class="fc" id="L86">    }</span>

    private void initPaneComponents() {
        // Define the default panel: each component on a vertical line
<span class="fc" id="L90">        this.getContentPane().setLayout(new BoxLayout(this.getContentPane(), BoxLayout.PAGE_AXIS));</span>

<span class="fc" id="L92">        this.tabManagers = new TabManagers();  // Tab manager linked to cards</span>
<span class="fc" id="L93">        this.add(this.tabManagers);</span>

<span class="fc" id="L95">        var menubar = new AppMenubar();</span>
<span class="fc" id="L96">        this.setJMenuBar(menubar);</span>
<span class="fc" id="L97">        MediatorHelper.register(menubar);</span>

<span class="fc" id="L99">        var panelAddressBar = new PanelAddressBar();  // Textfield at the top</span>
<span class="fc" id="L100">        MediatorHelper.register(panelAddressBar);</span>
<span class="fc" id="L101">        this.add(panelAddressBar);</span>

<span class="fc" id="L103">        var mainPanel = new JPanel(new BorderLayout());  // Main panel for tree and tables in the middle</span>
<span class="fc" id="L104">        this.splitNS = new SplitNS();</span>
<span class="fc" id="L105">        mainPanel.add(this.splitNS);</span>
<span class="fc" id="L106">        this.add(mainPanel);</span>

<span class="fc" id="L108">        menubar.getMenuWindows().switchLocaleFromPreferences();</span>
<span class="fc" id="L109">    }</span>

    private void initWindow() {
<span class="fc" id="L112">        this.setIconImages(UiUtil.getIcons());  // define small and large app icons</span>
<span class="fc" id="L113">        var preferences = Preferences.userRoot().node(InjectionModel.class.getName());</span>
<span class="pc bnc" id="L114" title="All 2 branches missed.">        this.addWindowStateListener(e -&gt; this.isMaximized = (e.getNewState() &amp; Frame.MAXIMIZED_BOTH) == Frame.MAXIMIZED_BOTH);</span>
<span class="fc" id="L115">        this.addWindowListener(new WindowAdapter() {</span>
            @Override
            public void windowOpened(WindowEvent event) {
<span class="fc" id="L118">                double nsProportion = preferences.getDouble(PreferencesUtil.NS_SPLIT, 0.75);</span>
<span class="fc" id="L119">                double ewProportion = preferences.getDouble(PreferencesUtil.EW_SPLIT, 0.33);</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">                if (preferences.getBoolean(PreferencesUtil.IS_MAXIMIZED, false)) {</span>
<span class="nc" id="L121">                    JFrameView.this.setExtendedState(Frame.MAXIMIZED_BOTH);</span>
                }
                // Proportion means different location relative to whether frame is maximized or not
                // Maximizing must wait AWT events to reflect the new divider location proportion
<span class="fc" id="L125">                SwingUtilities.invokeLater(() -&gt; {</span>
<span class="fc" id="L126">                    JFrameView.this.splitNS.setDividerLocation(</span>
<span class="fc" id="L127">                        Math.max(0.0, Math.min(1.0, nsProportion))</span>
                    );
<span class="fc" id="L129">                    JFrameView.this.splitNS.getSplitEW().setDividerLocation(</span>
<span class="fc" id="L130">                        Math.max(0.0, Math.min(1.0, ewProportion))</span>
                    );
<span class="fc" id="L132">                    MediatorHelper.panelConsoles().networkSplitPane.setDividerLocation(</span>
<span class="pc bpc" id="L133" title="1 of 2 branches missed.">                        ComponentOrientation.getOrientation(I18nUtil.getCurrentLocale()).isLeftToRight()</span>
<span class="fc" id="L134">                        ? 0.33</span>
<span class="nc" id="L135">                        : 0.66</span>
                    );
<span class="fc" id="L137">                });</span>
<span class="fc" id="L138">            }</span>

            @Override
            public void windowClosing(WindowEvent e) {
<span class="nc" id="L142">                preferences.putBoolean(PreferencesUtil.IS_MAXIMIZED, JFrameView.this.isMaximized);</span>

<span class="nc" id="L144">                int ewDividerLocation = JFrameView.this.splitNS.getSplitEW().getDividerLocation();</span>
<span class="nc" id="L145">                int ewHeight = JFrameView.this.splitNS.getSplitEW().getWidth();</span>
<span class="nc" id="L146">                double ewProportion = 100.0 * ewDividerLocation / ewHeight;</span>
<span class="nc" id="L147">                double ewLocationProportionCapped = Math.max(0.0, Math.min(1.0,</span>
                    ewProportion / 100.0
                ));

<span class="nc" id="L151">                int nsDividerLocation = JFrameView.this.splitNS.getDividerLocation();</span>
<span class="nc" id="L152">                int nsHeight = JFrameView.this.splitNS.getHeight();</span>
<span class="nc" id="L153">                double nsProportion = 100.0 * nsDividerLocation / nsHeight;</span>
<span class="nc" id="L154">                double nsLocationProportionCapped = Math.max(0.0, Math.min(1.0,</span>
                    nsProportion / 100.0
                ));

                // Divider location changes when window is maximized, instead stores location percentage between 0.0 and 1.0
<span class="nc" id="L159">                preferences.putDouble(PreferencesUtil.NS_SPLIT, nsLocationProportionCapped);</span>
<span class="nc" id="L160">                preferences.putDouble(PreferencesUtil.EW_SPLIT, ewLocationProportionCapped);</span>

<span class="nc" id="L162">                preferences.putBoolean(PreferencesUtil.BINARY_VISIBLE, false);</span>
<span class="nc" id="L163">                preferences.putBoolean(PreferencesUtil.CHUNK_VISIBLE, false);</span>
<span class="nc" id="L164">                preferences.putBoolean(PreferencesUtil.NETWORK_VISIBLE, false);</span>
<span class="nc" id="L165">                preferences.putBoolean(PreferencesUtil.JAVA_VISIBLE, false);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">                for (var i = 0 ; i &lt; MediatorHelper.tabConsoles().getTabCount() ; i++) {</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">                    if (&quot;CONSOLE_BINARY_LABEL&quot;.equals(MediatorHelper.tabConsoles().getTabComponentAt(i).getName())) {</span>
<span class="nc" id="L168">                        preferences.putBoolean(PreferencesUtil.BINARY_VISIBLE, true);</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">                    } else if (&quot;CONSOLE_CHUNK_LABEL&quot;.equals(MediatorHelper.tabConsoles().getTabComponentAt(i).getName())) {</span>
<span class="nc" id="L170">                        preferences.putBoolean(PreferencesUtil.CHUNK_VISIBLE, true);</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">                    } else if (&quot;CONSOLE_NETWORK_LABEL&quot;.equals(MediatorHelper.tabConsoles().getTabComponentAt(i).getName())) {</span>
<span class="nc" id="L172">                        preferences.putBoolean(PreferencesUtil.NETWORK_VISIBLE, true);</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">                    } else if (&quot;CONSOLE_JAVA_LABEL&quot;.equals(MediatorHelper.tabConsoles().getTabComponentAt(i).getName())) {</span>
<span class="nc" id="L174">                        preferences.putBoolean(PreferencesUtil.JAVA_VISIBLE, true);</span>
                    }
                }
<span class="nc" id="L177">            }</span>
        });
        
<span class="fc" id="L180">        this.setSize(1024, 768);</span>
<span class="fc" id="L181">        this.setLocationRelativeTo(null);  // center the window</span>
<span class="fc" id="L182">        this.setDefaultCloseOperation(WindowConstants.EXIT_ON_CLOSE);</span>
<span class="fc" id="L183">    }</span>

    private void initShortcuts() {
<span class="fc" id="L186">        HotkeyUtil.addShortcut(this.getRootPane(), MediatorHelper.tabResults());</span>
<span class="fc" id="L187">        HotkeyUtil.addTextFieldShortcutSelectAll();</span>
<span class="fc" id="L188">    }</span>

    public void resetInterface() {  // Empty the interface
<span class="fc" id="L191">        this.mapUuidShell.clear();</span>
<span class="fc" id="L192">        MediatorHelper.panelAddressBar().getPanelTrailingAddress().reset();</span>
<span class="fc" id="L193">        MediatorHelper.panelConsoles().reset();</span>
<span class="fc" id="L194">        MediatorHelper.treeDatabase().reset();</span>
        
<span class="fc bfc" id="L196" title="All 2 branches covered.">        for (var i = 0 ; i &lt; MediatorHelper.tabConsoles().getTabCount() ; i++) {</span>
<span class="fc" id="L197">            var tabComponent = MediatorHelper.tabConsoles().getTabComponentAt(i);</span>
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">            if (tabComponent != null) {</span>
<span class="fc" id="L199">                tabComponent.setFont(tabComponent.getFont().deriveFont(Font.PLAIN));</span>
            }
        }
        
<span class="fc" id="L203">        Stream.of(MediatorHelper.managerFile(), MediatorHelper.managerExploit()).forEach(managerList -&gt; {</span>
<span class="fc" id="L204">            managerList.setButtonEnable(false);</span>
<span class="fc" id="L205">            managerList.changePrivilegeIcon(UiUtil.SQUARE.getIcon());</span>
<span class="fc" id="L206">        });</span>
<span class="fc" id="L207">    }</span>

    private void displayVersion() {
<span class="fc" id="L210">        LOGGER.log(</span>
            LogLevelUtil.CONSOLE_DEFAULT,
            &quot;{} v{} on Java {}-{}-{}&quot;,
<span class="fc" id="L213">            () -&gt; StringUtil.APP_NAME,</span>
<span class="fc" id="L214">            () -&gt; this.injectionModel.getPropertiesUtil().getVersionJsql(),</span>
<span class="fc" id="L215">            () -&gt; SystemUtils.JAVA_VERSION,</span>
<span class="fc" id="L216">            () -&gt; SystemUtils.OS_ARCH,</span>
<span class="fc" id="L217">            () -&gt; SystemUtils.USER_LANGUAGE</span>
        );
<span class="fc" id="L219">    }</span>

    private void check4K() {
<span class="fc" id="L222">        Dimension screenSize = Toolkit.getDefaultToolkit().getScreenSize();</span>
<span class="fc" id="L223">        int width = (int) screenSize.getWidth();</span>
<span class="pc bpc" id="L224" title="3 of 4 branches missed.">        if (width &gt;= 3840 &amp;&amp; !this.injectionModel.getMediatorUtils().getPreferencesUtil().is4K()) {</span>
<span class="nc" id="L225">            LOGGER.log(LogLevelUtil.CONSOLE_ERROR, &quot;Screen compatible with resolution 4K, enable high-definition in Preferences&quot;);</span>
        }
<span class="fc" id="L227">    }</span>


    // Getters and setters

    public final Map&lt;UUID, AbstractExploit&gt; getMapUuidShell() {
<span class="fc" id="L233">        return this.mapUuidShell;</span>
    }

    public SubscriberInteraction getSubscriber() {
<span class="fc" id="L237">        return this.subscriber;</span>
    }

    public SplitNS getSplitNS() {
<span class="fc" id="L241">        return this.splitNS;</span>
    }

    public TabManagers getTabManagers() {
<span class="fc" id="L245">        return this.tabManagers;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>