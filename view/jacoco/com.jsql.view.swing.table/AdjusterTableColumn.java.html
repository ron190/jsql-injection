<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AdjusterTableColumn.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">view</a> &gt; <a href="index.source.html" class="el_package">com.jsql.view.swing.table</a> &gt; <span class="el_source">AdjusterTableColumn.java</span></div><h1>AdjusterTableColumn.java</h1><pre class="source lang-java linenums">package com.jsql.view.swing.table;

import com.jsql.util.LogLevelUtil;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

import javax.swing.*;
import javax.swing.event.TableModelEvent;
import javax.swing.event.TableModelListener;
import javax.swing.table.TableCellRenderer;
import javax.swing.table.TableColumn;
import javax.swing.table.TableColumnModel;
import javax.swing.table.TableModel;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.beans.PropertyChangeEvent;
import java.beans.PropertyChangeListener;
import java.util.HashMap;
import java.util.Map;

/**
 * Class to manage the widths of columns in a table.
 *
 * Various properties control how the width of the column is calculated.
 * Another property controls whether column width calculation should be dynamic.
 * Finally, various Actions will be added to the table to allow the user
 * to customize the functionality.
 *
 * This class was designed to be used with tables that use an auto resize mode
 * of AUTO_RESIZE_OFF. With all other modes you are constrained as the width
 * of the columns must fit inside the table. So if you increase one column, one
 * or more of the other columns must decrease. Because of this the resize mode
 * of RESIZE_ALL_COLUMNS will work the best.
 */
public class AdjusterTableColumn implements PropertyChangeListener, TableModelListener {

<span class="fc" id="L37">    private static final Logger LOGGER = LogManager.getRootLogger();</span>

    private final JTable tableAdjust;
    private final int spacing;
    private boolean isColumnHeaderIncluded;
    private boolean isColumnDataIncluded;
    private boolean isOnlyAdjustLarger;
    private boolean isDynamicAdjustment;
<span class="fc" id="L45">    private final Map&lt;TableColumn, Integer&gt; columnSizes = new HashMap&lt;&gt;();</span>

    /**
     * Specify the table and use default spacing
     */
    public AdjusterTableColumn(JTable table) {
<span class="fc" id="L51">        this(table, 6);</span>
<span class="fc" id="L52">    }</span>

    /**
     * Specify the table and spacing
     */
<span class="fc" id="L57">    public AdjusterTableColumn(JTable tableAdjust, int spacing) {</span>
<span class="fc" id="L58">        this.tableAdjust = tableAdjust;</span>
<span class="fc" id="L59">        this.spacing = spacing;</span>
<span class="fc" id="L60">        this.setColumnHeaderIncluded(true);</span>
<span class="fc" id="L61">        this.setColumnDataIncluded(true);</span>
<span class="fc" id="L62">        this.setOnlyAdjustLarger(true);</span>
<span class="fc" id="L63">        this.setDynamicAdjustment(false);</span>
<span class="fc" id="L64">        this.installActions();</span>
<span class="fc" id="L65">    }</span>

    /**
     * Adjust the widths of all the columns in the table
     */
    public void adjustColumns() {
<span class="fc" id="L71">        TableColumnModel tcm = this.tableAdjust.getColumnModel();</span>
<span class="fc bfc" id="L72" title="All 2 branches covered.">        for (var i = 0 ; i &lt; tcm.getColumnCount() ; i++) {</span>
<span class="fc" id="L73">            this.adjustColumn(i);</span>
        }
<span class="fc" id="L75">    }</span>

    /**
     * Adjust the width of the specified column in the table
     */
    public void adjustColumn(final int column) {
<span class="fc" id="L81">        var tableColumn = this.tableAdjust.getColumnModel().getColumn(column);</span>
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">        if (!tableColumn.getResizable()) {</span>
<span class="nc" id="L83">            return;</span>
        }

<span class="fc" id="L86">        int columnHeaderWidth = this.getColumnHeaderWidth(column);</span>
<span class="fc" id="L87">        int columnDataWidth   = this.getColumnDataWidth(column);</span>
<span class="fc" id="L88">        int preferredWidth    = Math.max(columnHeaderWidth, columnDataWidth);</span>
<span class="fc" id="L89">        this.updateTableColumn(column, preferredWidth);</span>
<span class="fc" id="L90">    }</span>

    /**
     * Calculated the width based on the column name
     */
    private int getColumnHeaderWidth(int column) {
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">        if (!this.isColumnHeaderIncluded) {</span>
<span class="nc" id="L97">            return 0;</span>
        }

<span class="fc" id="L100">        var tableColumn = this.tableAdjust.getColumnModel().getColumn(column);</span>
<span class="fc" id="L101">        Object value = tableColumn.getHeaderValue();</span>
<span class="fc" id="L102">        TableCellRenderer renderer = tableColumn.getHeaderRenderer();</span>
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">        if (renderer == null) {</span>
<span class="fc" id="L104">            renderer = this.tableAdjust.getTableHeader().getDefaultRenderer();</span>
        }

<span class="fc" id="L107">        var c = renderer.getTableCellRendererComponent(this.tableAdjust, value, false, false, -1, column);</span>
<span class="fc" id="L108">        return c.getPreferredSize().width;</span>
    }

    /**
     * Calculate the width based on the widest cell renderer for the
     * given column.
     */
    private int getColumnDataWidth(int column) {
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">        if (!this.isColumnDataIncluded) {</span>
<span class="nc" id="L117">            return 0;</span>
        }

<span class="fc" id="L120">        var preferredWidth = 0;</span>
<span class="fc" id="L121">        int maxWidth = this.tableAdjust.getColumnModel().getColumn(column).getMaxWidth();</span>

<span class="fc bfc" id="L123" title="All 2 branches covered.">        for (var row = 0 ; row &lt; this.tableAdjust.getRowCount() ; row++) {</span>
<span class="fc" id="L124">            preferredWidth = Math.max(preferredWidth, this.getCellDataWidth(row, column));</span>
            // We've exceeded the maximum width, no need to check other rows
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">            if (preferredWidth &gt;= maxWidth) {</span>
<span class="nc" id="L127">                break;</span>
            }
        }
<span class="fc" id="L130">        return preferredWidth;</span>
    }

    /**
     * Get the preferred width for the specified cell
     */
    private int getCellDataWidth(int row, int column) {
        // Invoke the renderer for the cell to calculate the preferred width
<span class="fc" id="L138">        TableCellRenderer cellRenderer = this.tableAdjust.getCellRenderer(row, column);</span>
<span class="fc" id="L139">        Component c = this.tableAdjust.prepareRenderer(cellRenderer, row, column);</span>
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">        if (c != null) {  // Fix #96130: NullPointerException on c</span>
<span class="fc" id="L141">            return c.getPreferredSize().width + this.tableAdjust.getIntercellSpacing().width;</span>
        } else {
<span class="nc" id="L143">            LOGGER.log(LogLevelUtil.CONSOLE_JAVA, &quot;Unexpected missing cell, data width set to 0&quot;);</span>
<span class="nc" id="L144">            return 100;</span>
        }
    }

    /**
     * Update the TableColumn with the newly calculated width
     */
    private void updateTableColumn(int column, int width) {
<span class="fc" id="L152">        final var tableColumn = this.tableAdjust.getColumnModel().getColumn(column);</span>
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">        if (!tableColumn.getResizable()) {</span>
<span class="nc" id="L154">            return;</span>
        }

<span class="fc" id="L157">        int calculatedWidth = width;</span>
<span class="fc" id="L158">        calculatedWidth += this.spacing;</span>
        // Don't shrink the column width
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">        if (this.isOnlyAdjustLarger) {</span>
<span class="fc" id="L161">            calculatedWidth = Math.max(calculatedWidth, tableColumn.getPreferredWidth());</span>
        }

<span class="fc" id="L164">        this.columnSizes.put(tableColumn, tableColumn.getWidth());</span>
<span class="fc" id="L165">        this.tableAdjust.getTableHeader().setResizingColumn(tableColumn);</span>
<span class="fc" id="L166">        tableColumn.setWidth(calculatedWidth);</span>
<span class="fc" id="L167">    }</span>

    /**
     * Restore the widths of the columns in the table to its previous width
     */
    public void restoreColumns() {
<span class="nc" id="L173">        TableColumnModel tableColumnModel = this.tableAdjust.getColumnModel();</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">        for (var i = 0 ; i &lt; tableColumnModel.getColumnCount() ; i++) {</span>
<span class="nc" id="L175">            this.restoreColumn(i);</span>
        }
<span class="nc" id="L177">    }</span>

    /**
     * Restore the width of the specified column to its previous width
     */
    private void restoreColumn(int column) {
<span class="nc" id="L183">        var tableColumn = this.tableAdjust.getColumnModel().getColumn(column);</span>
<span class="nc" id="L184">        Integer width = this.columnSizes.get(tableColumn);</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (width != null) {</span>
<span class="nc" id="L186">            this.tableAdjust.getTableHeader().setResizingColumn(tableColumn);</span>
<span class="nc" id="L187">            tableColumn.setWidth(width);</span>
        }
<span class="nc" id="L189">    }</span>

    /**
     * Indicates whether to include the header in the width calculation
     */
    public void setColumnHeaderIncluded(boolean isColumnHeaderIncluded) {
<span class="fc" id="L195">        this.isColumnHeaderIncluded = isColumnHeaderIncluded;</span>
<span class="fc" id="L196">    }</span>

    /**
     * Indicates whether to include the model data in the width calculation
     */
    public void setColumnDataIncluded(boolean isColumnDataIncluded) {
<span class="fc" id="L202">        this.isColumnDataIncluded = isColumnDataIncluded;</span>
<span class="fc" id="L203">    }</span>

    /**
     * Indicates whether columns can only be increased in size
     */
    public void setOnlyAdjustLarger(boolean isOnlyAdjustLarger) {
<span class="fc" id="L209">        this.isOnlyAdjustLarger = isOnlyAdjustLarger;</span>
<span class="fc" id="L210">    }</span>

    /**
     * Indicate whether changes to the model should cause the width to be
     * dynamically recalculated.
     */
    public void setDynamicAdjustment(boolean isDynamicAdjustment) {
        // May need to add or remove the TableModelListener when changed
<span class="pc bpc" id="L218" title="1 of 2 branches missed.">        if (this.isDynamicAdjustment != isDynamicAdjustment) {</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">            if (isDynamicAdjustment) {</span>
<span class="nc" id="L220">                this.tableAdjust.addPropertyChangeListener(this);</span>
<span class="nc" id="L221">                this.tableAdjust.getModel().addTableModelListener(this);</span>
            } else {
<span class="nc" id="L223">                this.tableAdjust.removePropertyChangeListener(this);</span>
<span class="nc" id="L224">                this.tableAdjust.getModel().removeTableModelListener(this);</span>
            }
        }
<span class="fc" id="L227">        this.isDynamicAdjustment = isDynamicAdjustment;</span>
<span class="fc" id="L228">    }</span>
    
    /**
     * Implement the PropertyChangeListener
     */
    @Override
    public void propertyChange(PropertyChangeEvent e) {
        // When the TableModel changes we need to update the listeners
        // and column widths
<span class="nc bnc" id="L237" title="All 2 branches missed.">        if (&quot;model&quot;.equals(e.getPropertyName())) {</span>
<span class="nc" id="L238">            TableModel model = (TableModel) e.getOldValue();</span>
<span class="nc" id="L239">            model.removeTableModelListener(this);</span>

<span class="nc" id="L241">            model = (TableModel) e.getNewValue();</span>
<span class="nc" id="L242">            model.addTableModelListener(this);</span>
<span class="nc" id="L243">            this.adjustColumns();</span>
        }
<span class="nc" id="L245">    }</span>
    
    /**
     * Implement the TableModelListener
     */
    @Override
    public void tableChanged(TableModelEvent e) {
<span class="nc bnc" id="L252" title="All 2 branches missed.">        if (!this.isColumnDataIncluded) {</span>
<span class="nc" id="L253">            return;</span>
        }

        // A cell has been updated
<span class="nc bnc" id="L257" title="All 2 branches missed.">        if (e.getType() == TableModelEvent.UPDATE) {</span>
<span class="nc" id="L258">            int column = this.tableAdjust.convertColumnIndexToView(e.getColumn());</span>

            // Only need to worry about an increase in width for this cell
<span class="nc bnc" id="L261" title="All 2 branches missed.">            if (this.isOnlyAdjustLarger) {</span>
<span class="nc" id="L262">                int row = e.getFirstRow();</span>
<span class="nc" id="L263">                var tableColumn = this.tableAdjust.getColumnModel().getColumn(column);</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">                if (tableColumn.getResizable()) {</span>
<span class="nc" id="L265">                    int width = this.getCellDataWidth(row, column);</span>
<span class="nc" id="L266">                    this.updateTableColumn(column, width);</span>
                }
<span class="nc" id="L268">            } else {</span>
<span class="nc" id="L269">                this.adjustColumn(column);  // Could be an increase of decrease so check all rows</span>
            }
<span class="nc" id="L271">        } else {</span>
<span class="nc" id="L272">            this.adjustColumns();  // The update affected more than one column so adjust all columns</span>
        }
<span class="nc" id="L274">    }</span>

    /**
     * Install Actions to give user control of certain functionality.
     */
    private void installActions() {
<span class="fc" id="L280">        this.installColumnAction(true,  true,  &quot;adjustColumn&quot;,   &quot;control ADD&quot;);</span>
<span class="fc" id="L281">        this.installColumnAction(false, true,  &quot;adjustColumns&quot;,  &quot;control shift ADD&quot;);</span>
<span class="fc" id="L282">        this.installColumnAction(true,  false, &quot;restoreColumn&quot;,  &quot;control SUBTRACT&quot;);</span>
<span class="fc" id="L283">        this.installColumnAction(false, false, &quot;restoreColumns&quot;, &quot;control shift SUBTRACT&quot;);</span>

<span class="fc" id="L285">        this.installToggleAction(true,  false, &quot;toggleDynamic&quot;,  &quot;control MULTIPLY&quot;);</span>
<span class="fc" id="L286">        this.installToggleAction(false, true,  &quot;toggleLarger&quot;,   &quot;control DIVIDE&quot;);</span>
<span class="fc" id="L287">    }</span>

    /**
     * Update the input and action maps with a new ColumnAction
     */
    private void installColumnAction(boolean isSelectedColumn, boolean isAdjust, String key, String keyStroke) {
<span class="fc" id="L293">        Action action = new ColumnAction(isSelectedColumn, isAdjust);</span>
<span class="fc" id="L294">        var ks = KeyStroke.getKeyStroke(keyStroke);</span>
        
<span class="fc" id="L296">        this.tableAdjust.getInputMap().put(ks, key);</span>
<span class="fc" id="L297">        this.tableAdjust.getActionMap().put(key, action);</span>
<span class="fc" id="L298">    }</span>

    /**
     * Update the input and action maps with new ToggleAction
     */
    private void installToggleAction(boolean isToggleDynamic, boolean isToggleLarger, String key, String keyStroke) {
<span class="fc" id="L304">        Action action = new ToggleAction(isToggleDynamic, isToggleLarger);</span>
<span class="fc" id="L305">        var ks = KeyStroke.getKeyStroke(keyStroke);</span>
        
<span class="fc" id="L307">        this.tableAdjust.getInputMap().put(ks, key);</span>
<span class="fc" id="L308">        this.tableAdjust.getActionMap().put(key, action);</span>
<span class="fc" id="L309">    }</span>

    /**
     * Action to adjust or restore the width of a single column or all columns
     */
    private class ColumnAction extends AbstractAction {
        
        private final boolean isSelectedColumn;
        private final boolean isAdjust;

<span class="fc" id="L319">        ColumnAction(boolean isSelectedColumn, boolean isAdjust) {</span>
<span class="fc" id="L320">            this.isSelectedColumn = isSelectedColumn;</span>
<span class="fc" id="L321">            this.isAdjust = isAdjust;</span>
<span class="fc" id="L322">        }</span>

        @Override
        public void actionPerformed(ActionEvent e) {
            // Handle selected column(s) width change actions
<span class="nc bnc" id="L327" title="All 2 branches missed.">            if (this.isSelectedColumn) {</span>
<span class="nc" id="L328">                int[] columns = AdjusterTableColumn.this.tableAdjust.getSelectedColumns();</span>

<span class="nc bnc" id="L330" title="All 2 branches missed.">                for (int column: columns) {</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">                    if (this.isAdjust) {</span>
<span class="nc" id="L332">                        AdjusterTableColumn.this.adjustColumn(column);</span>
                    } else {
<span class="nc" id="L334">                        AdjusterTableColumn.this.restoreColumn(column);</span>
                    }
                }
<span class="nc" id="L337">            } else {</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">                if (this.isAdjust) {</span>
<span class="nc" id="L339">                    AdjusterTableColumn.this.adjustColumns();</span>
                } else {
<span class="nc" id="L341">                    AdjusterTableColumn.this.restoreColumns();</span>
                }
            }
<span class="nc" id="L344">        }</span>
    }

    /**
     * Toggle properties of the TableColumnAdjuster so the user can
     * customize the functionality to their preferences
     */
    private class ToggleAction extends AbstractAction {
        
        private final boolean isToggleDynamic;
        private final boolean isToggleLarger;

<span class="fc" id="L356">        ToggleAction(boolean isToggleDynamic, boolean isToggleLarger) {</span>
<span class="fc" id="L357">            this.isToggleDynamic = isToggleDynamic;</span>
<span class="fc" id="L358">            this.isToggleLarger = isToggleLarger;</span>
<span class="fc" id="L359">        }</span>

        @Override
        public void actionPerformed(ActionEvent e) {
<span class="nc bnc" id="L363" title="All 2 branches missed.">            if (this.isToggleDynamic) {</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">                AdjusterTableColumn.this.setDynamicAdjustment(!AdjusterTableColumn.this.isDynamicAdjustment);</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">            } else if (this.isToggleLarger) {</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">                AdjusterTableColumn.this.setOnlyAdjustLarger(!AdjusterTableColumn.this.isOnlyAdjustLarger);</span>
            }
<span class="nc" id="L368">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>