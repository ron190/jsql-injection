<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EngineYaml.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">model</a> &gt; <a href="index.source.html" class="el_package">com.jsql.model.injection.engine.model</a> &gt; <span class="el_source">EngineYaml.java</span></div><h1>EngineYaml.java</h1><pre class="source lang-java linenums">package com.jsql.model.injection.engine.model;

import com.jsql.model.InjectionModel;
import com.jsql.model.bean.database.Database;
import com.jsql.model.bean.database.Table;
import com.jsql.model.injection.strategy.blind.AbstractInjectionBit.BlindOperator;
import com.jsql.model.injection.engine.model.yaml.Method;
import com.jsql.model.injection.engine.model.yaml.ModelYaml;
import com.jsql.util.LogLevelUtil;
import com.jsql.util.StringUtil;
import org.apache.commons.codec.binary.Hex;
import org.apache.commons.lang3.RandomStringUtils;
import org.apache.commons.lang3.StringUtils;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.yaml.snakeyaml.Yaml;

import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.concurrent.ThreadLocalRandom;
import java.util.regex.Pattern;

import static com.jsql.model.accessible.DataAccess.*;

public class EngineYaml implements AbstractEngine {
    
<span class="fc" id="L30">    private static final Logger LOGGER = LogManager.getRootLogger();</span>

    /**
     * SQL characters marking the end of the result of an injection.
     * Process stops when this schema is encountered:
     * &lt;pre&gt;SqLix01x03x03x07
     */
    public static final String LEAD_HEX = &quot;0x53714c69&quot;;
    public static final String LEAD_PIPE = &quot;Sq'||'Li&quot;;
    public static final String TRAIL_SQL = &quot;%01%03%03%07&quot;;
    public static final String TRAIL_HEX = &quot;0x01030307&quot;;

    /**
     * SQL character used between each table cells.
     * Expected schema of multiple table cells :
     * &lt;pre&gt;
     * %04[table cell]%05[number of occurrences]%04%06%04[table cell]%05[number of occurrences]%04
     */
    public static final String SEPARATOR_CELL_SQL = &quot;%06&quot;;
    public static final String SEPARATOR_CELL_HEX = &quot;0x06&quot;;

    public static final String ENCLOSE_VALUE_HEX = &quot;0x04&quot;;

    /**
     * SQL character used between the table cell and the number of occurrence of the cell text.
     * Expected schema of a table cell data is
     * &lt;pre&gt;%04[table cell]%05[number of occurrences]%04
     */
    public static final String SEPARATOR_QTE_SQL = &quot;%05&quot;;
    public static final String SEPARATOR_QTE_HEX = &quot;0x05&quot;;

    /**
     * SQL character enclosing a table cell returned by injection.
     * It allows to detect the correct end of a table cell data during parsing.
     * Expected schema of a table cell data is
     * &lt;pre&gt;%04[table cell]%05[number of occurrences]%04
     */
    public static final String ENCLOSE_VALUE_SQL = &quot;%04&quot;;

    public static final String CALIBRATOR_SQL = &quot;a&quot;;
    public static final String CALIBRATOR_HEX = &quot;0x61&quot;;
    
    public static final String FORMAT_INDEX = &quot;1337%s7331&quot;;

    private static final String BINARY_MODE = &quot;${binary.mode}&quot;;
    public static final String LIMIT = &quot;${limit}&quot;;
    private static final String LIMIT_VALUE = &quot;${limit.value}&quot;;
    private static final String RESULT_RANGE = &quot;${result_range}&quot;;
    private static final String INDICE_UNIQUE = &quot;${indice_unique}&quot;;
    private static final String CALIBRATOR = &quot;${calibrator}&quot;;
    private static final String INDICES = &quot;${indices}&quot;;
    public static final String INDICE = &quot;${indice}&quot;;
    public static final String WINDOW_CHAR = &quot;${window.char}&quot;;
    public static final String BLOCK_MULTIBIT = &quot;${multibit.block}&quot;;
    public static final String WINDOW = &quot;${window}&quot;;
    public static final String CAPACITY = &quot;${capacity}&quot;;
    public static final String DEFAULT_CAPACITY = &quot;65565&quot;;
    private static final String SLEEP_TIME = &quot;${sleep_time}&quot;;
    private static final String BIT = &quot;${bit}&quot;;
    private static final String MID_CHR = &quot;${mid}&quot;;
    private static final String MID_INT = &quot;${mid.int}&quot;;
    public static final String INJECTION = &quot;${injection}&quot;;
    public static final String TEST = &quot;${test}&quot;;
    public static final String FILEPATH_HEX = &quot;${filepath.hex}&quot;;
    private static final String FIELDS = &quot;${fields}&quot;;
    private static final String FIELD = &quot;${field.value}&quot;;
    private static final String TABLE = &quot;${table}&quot;;
    private static final String DATABASE = &quot;${database}&quot;;
    private static final String TABLE_HEX = &quot;${table.hex}&quot;;
    private static final String DATABASE_HEX = &quot;${database.hex}&quot;;
    private static final String DNS_DOMAIN = &quot;${dns.domain}&quot;;
    private static final String DNS_RANDOM = &quot;${dns.random}&quot;;

    private final ModelYaml modelYaml;
    private final InjectionModel injectionModel;
    
<span class="fc" id="L106">    public EngineYaml(String fileYaml, InjectionModel injectionModel) {</span>
<span class="fc" id="L107">        this.injectionModel = injectionModel;</span>
<span class="fc" id="L108">        var yaml = new Yaml();</span>
<span class="fc" id="L109">        this.modelYaml = yaml.loadAs(</span>
<span class="fc" id="L110">            EngineYaml.class.getClassLoader().getResourceAsStream(&quot;engine/&quot; + fileYaml),</span>
            ModelYaml.class
        );
<span class="fc" id="L113">    }</span>

    @Override
    public String sqlDatabases() {
<span class="fc" id="L117">        String sqlQuery = this.modelYaml.getResource().getSchema().getDatabase();</span>
        
<span class="fc bfc" id="L119" title="All 2 branches covered.">        if (this.injectionModel.getMediatorUtils().preferencesUtil().isDiosStrategy()) {</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">            if (StringUtils.isNotBlank(this.modelYaml.getResource().getDios().getDatabase())) {</span>
<span class="fc" id="L121">                sqlQuery = this.modelYaml.getResource().getDios().getDatabase();</span>
            } else {
<span class="nc" id="L123">                LOGGER.log(</span>
                    LogLevelUtil.CONSOLE_INFORM,
                    &quot;Strategy [Dios] activated but database query is undefined for [{}], fallback to default&quot;,
<span class="nc" id="L126">                    () -&gt; this.injectionModel.getMediatorEngine().getEngine()</span>
                );
            }
<span class="fc bfc" id="L129" title="All 2 branches covered.">        } else if (this.injectionModel.getMediatorUtils().preferencesUtil().isZipStrategy()) {</span>
<span class="pc bpc" id="L130" title="1 of 2 branches missed.">            if (StringUtils.isNotBlank(this.modelYaml.getResource().getZip().getDatabase())) {</span>
<span class="fc" id="L131">                sqlQuery = this.modelYaml.getResource().getZip().getDatabase();</span>
            } else {
<span class="nc" id="L133">                LOGGER.log(</span>
                    LogLevelUtil.CONSOLE_INFORM,
                    &quot;Strategy [Zip] activated but database query is undefined for [{}], fallback to default&quot;,
<span class="nc" id="L136">                    () -&gt; this.injectionModel.getMediatorEngine().getEngine()</span>
                );
            }
        }
<span class="fc" id="L140">        return sqlQuery;</span>
    }
    
    @Override
    public String sqlTables(Database database) {
<span class="fc" id="L145">        String sqlQuery = this.modelYaml.getResource().getSchema().getTable();</span>
        
<span class="fc bfc" id="L147" title="All 2 branches covered.">        if (this.injectionModel.getMediatorUtils().preferencesUtil().isDiosStrategy()) {</span>
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">            if (StringUtils.isNotBlank(this.modelYaml.getResource().getDios().getTable())) {</span>
<span class="fc" id="L149">                sqlQuery = this.modelYaml.getResource().getDios().getTable();</span>
            } else {
<span class="nc" id="L151">                LOGGER.log(</span>
                    LogLevelUtil.CONSOLE_INFORM,
                    &quot;Strategy [Dios] activated but table query is undefined for [{}], fallback to default&quot;,
<span class="nc" id="L154">                    () -&gt; this.injectionModel.getMediatorEngine().getEngine()</span>
                );
            }
<span class="fc bfc" id="L157" title="All 2 branches covered.">        } else if (this.injectionModel.getMediatorUtils().preferencesUtil().isZipStrategy()) {</span>
<span class="pc bpc" id="L158" title="1 of 2 branches missed.">            if (StringUtils.isNotBlank(this.modelYaml.getResource().getZip().getTable())) {</span>
<span class="fc" id="L159">                sqlQuery = this.modelYaml.getResource().getZip().getTable();</span>
            } else {
<span class="nc" id="L161">                LOGGER.log(</span>
                    LogLevelUtil.CONSOLE_INFORM,
                    &quot;Strategy [Zip] activated but table query is undefined for [{}], fallback to default&quot;,
<span class="nc" id="L164">                    () -&gt; this.injectionModel.getMediatorEngine().getEngine()</span>
                );
            }
        }
        
<span class="fc" id="L169">        String databaseUtf8 = Hex.encodeHexString(database.toString().getBytes(StandardCharsets.UTF_8));</span>
<span class="fc" id="L170">        return sqlQuery</span>
<span class="fc" id="L171">            .replace(EngineYaml.DATABASE_HEX, databaseUtf8)</span>
<span class="fc" id="L172">            .replace(EngineYaml.DATABASE, database.toString());</span>
    }

    @Override
    public String sqlColumns(Table table) {
<span class="fc" id="L177">        String sqlQuery = this.modelYaml.getResource().getSchema().getColumn();</span>
        
<span class="fc bfc" id="L179" title="All 2 branches covered.">        if (this.injectionModel.getMediatorUtils().preferencesUtil().isDiosStrategy()) {</span>
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">            if (StringUtils.isNotBlank(this.modelYaml.getResource().getDios().getColumn())) {</span>
<span class="fc" id="L181">                sqlQuery = this.modelYaml.getResource().getDios().getColumn();</span>
            } else {
<span class="nc" id="L183">                LOGGER.log(</span>
                    LogLevelUtil.CONSOLE_INFORM,
                    &quot;Strategy [Dios] activated but column query is undefined for [{}], fallback to default&quot;,
<span class="nc" id="L186">                    () -&gt; this.injectionModel.getMediatorEngine().getEngine()</span>
                );
            }
<span class="fc bfc" id="L189" title="All 2 branches covered.">        } else if (this.injectionModel.getMediatorUtils().preferencesUtil().isZipStrategy()) {</span>
<span class="pc bpc" id="L190" title="1 of 2 branches missed.">            if (StringUtils.isNotBlank(this.modelYaml.getResource().getZip().getColumn())) {</span>
<span class="fc" id="L191">                sqlQuery = this.modelYaml.getResource().getZip().getColumn();</span>
            } else {
<span class="nc" id="L193">                LOGGER.log(</span>
                    LogLevelUtil.CONSOLE_INFORM,
                    &quot;Strategy [Zip] activated but column query is undefined for [{}], fallback to default&quot;,
<span class="nc" id="L196">                    () -&gt; this.injectionModel.getMediatorEngine().getEngine()</span>
                );
            }
        }
        
<span class="fc" id="L201">        String databaseUtf8 = Hex.encodeHexString(table.getParent().toString().getBytes(StandardCharsets.UTF_8));</span>
<span class="fc" id="L202">        String tableUtf8 = Hex.encodeHexString(table.toString().getBytes(StandardCharsets.UTF_8));</span>
        
<span class="fc" id="L204">        return sqlQuery</span>
<span class="fc" id="L205">            .replace(EngineYaml.DATABASE_HEX, databaseUtf8)</span>
<span class="fc" id="L206">            .replace(EngineYaml.TABLE_HEX, tableUtf8)</span>
<span class="fc" id="L207">            .replace(EngineYaml.DATABASE, table.getParent().toString())</span>
<span class="fc" id="L208">            .replace(EngineYaml.TABLE, table.toString());</span>
    }

    @Override
    public String sqlRows(String[] namesColumns, Database database, Table table) {
<span class="fc" id="L213">        String sqlField = this.modelYaml.getResource().getSchema().getRow().getFields().getField();</span>
<span class="fc" id="L214">        String sqlConcatFields = this.modelYaml.getResource().getSchema().getRow().getFields().getConcat();</span>
<span class="fc" id="L215">        String sqlQuery = this.modelYaml.getResource().getSchema().getRow().getQuery();</span>
        
<span class="fc bfc" id="L217" title="All 2 branches covered.">        if (this.injectionModel.getMediatorUtils().preferencesUtil().isDiosStrategy()) {</span>
<span class="pc bpc" id="L218" title="1 of 2 branches missed.">            if (StringUtils.isNotBlank(this.modelYaml.getResource().getDios().getDatabase())) {</span>
<span class="fc" id="L219">                sqlField = this.modelYaml.getResource().getDios().getRow().getFields().getField();</span>
<span class="fc" id="L220">                sqlConcatFields = this.modelYaml.getResource().getDios().getRow().getFields().getConcat();</span>
<span class="fc" id="L221">                sqlQuery = this.modelYaml.getResource().getDios().getRow().getQuery();</span>
            } else {
<span class="nc" id="L223">                LOGGER.log(</span>
                    LogLevelUtil.CONSOLE_INFORM,
                    &quot;Strategy [Dios] activated but row query is undefined for [{}], fallback to default&quot;,
<span class="nc" id="L226">                    () -&gt; this.injectionModel.getMediatorEngine().getEngine()</span>
                );
            }
<span class="fc bfc" id="L229" title="All 2 branches covered.">        } else if (this.injectionModel.getMediatorUtils().preferencesUtil().isZipStrategy()) {</span>
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">            if (StringUtils.isNotBlank(this.modelYaml.getResource().getZip().getDatabase())) {</span>
<span class="fc" id="L231">                sqlField = this.modelYaml.getResource().getZip().getRow().getFields().getField();</span>
<span class="fc" id="L232">                sqlConcatFields = this.modelYaml.getResource().getZip().getRow().getFields().getConcat();</span>
<span class="fc" id="L233">                sqlQuery = this.modelYaml.getResource().getZip().getRow().getQuery();</span>
            } else {
<span class="nc" id="L235">                LOGGER.log(</span>
                    LogLevelUtil.CONSOLE_INFORM,
                    &quot;Strategy [Zip] activated but row query is undefined for [{}], fallback to default&quot;,
<span class="nc" id="L238">                    () -&gt; this.injectionModel.getMediatorEngine().getEngine()</span>
                );
            }
        }
        
<span class="fc" id="L243">        var matcherSqlField = Pattern.compile(&quot;(?s)(.*)&quot;+ Pattern.quote(EngineYaml.FIELD) +&quot;(.*)&quot;).matcher(sqlField);</span>
<span class="fc" id="L244">        String leadSqlField = StringUtils.EMPTY;</span>
<span class="fc" id="L245">        String trailSqlField = StringUtils.EMPTY;</span>
        
<span class="pc bpc" id="L247" title="1 of 2 branches missed.">        if (matcherSqlField.find()) {</span>
<span class="fc" id="L248">            leadSqlField = matcherSqlField.group(1);</span>
<span class="fc" id="L249">            trailSqlField = matcherSqlField.group(2);</span>
        }
        
<span class="fc" id="L252">        var namesColumnUtf8 = new String[namesColumns.length];</span>
<span class="fc bfc" id="L253" title="All 2 branches covered.">        for (var i = 0 ; i &lt; namesColumns.length ; i++) {</span>
<span class="fc" id="L254">            namesColumnUtf8[i] = StringUtil.detectUtf8(namesColumns[i]);</span>
<span class="fc" id="L255">            namesColumnUtf8[i] = URLEncoder.encode(namesColumnUtf8[i], StandardCharsets.UTF_8);</span>
        }
        
<span class="fc" id="L258">        var nameDatabaseUtf8 = StringUtil.detectUtf8(database.toString());</span>
<span class="fc" id="L259">        nameDatabaseUtf8 = URLEncoder.encode(nameDatabaseUtf8, StandardCharsets.UTF_8);</span>
        
<span class="fc" id="L261">        var nameTableUtf8 = StringUtil.detectUtf8(table.toString());</span>
<span class="fc" id="L262">        nameTableUtf8 = URLEncoder.encode(nameTableUtf8, StandardCharsets.UTF_8);</span>
        
<span class="fc" id="L264">        return sqlQuery.replace(</span>
                EngineYaml.FIELDS,
                leadSqlField
<span class="fc" id="L267">                + String.join(</span>
                    trailSqlField + sqlConcatFields + leadSqlField,
                    namesColumnUtf8
                )
                + trailSqlField
            )
<span class="fc" id="L273">            .replace(EngineYaml.DATABASE, nameDatabaseUtf8)</span>
<span class="fc" id="L274">            .replace(EngineYaml.TABLE, nameTableUtf8);</span>
    }

    @Override
    public String sqlTestBlindWithOperator(String check, BlindOperator blindOperator) {
<span class="fc" id="L279">        String replacement = this.getMode(blindOperator);</span>
<span class="fc" id="L280">        return this.modelYaml.getStrategy().getBinary().getBlind()</span>
<span class="fc" id="L281">            .replace(EngineYaml.BINARY_MODE, replacement)</span>
<span class="fc" id="L282">            .replace(EngineYaml.TEST, check)</span>
<span class="fc" id="L283">            .trim();  // trim spaces in '${binary.mode} ${test}' when no mode, not covered by cleanSql()</span>
    }

    @Override
    public String sqlBlindBit(String inj, int indexChar, int bit, BlindOperator blindOperator) {
<span class="fc" id="L288">        String replacement = this.getMode(blindOperator);</span>
<span class="fc" id="L289">        return this.modelYaml.getStrategy().getBinary().getBlind()</span>
<span class="fc" id="L290">            .replace(EngineYaml.BINARY_MODE, replacement)</span>
<span class="fc" id="L291">            .replace(</span>
                EngineYaml.TEST,
<span class="fc" id="L293">                this.modelYaml.getStrategy().getBinary().getTest().getBit()</span>
<span class="fc" id="L294">                .replace(EngineYaml.INJECTION, inj)</span>
<span class="fc" id="L295">                .replace(EngineYaml.WINDOW_CHAR, Integer.toString(indexChar))</span>
<span class="fc" id="L296">                .replace(EngineYaml.BIT, Integer.toString(bit))</span>
            )
<span class="fc" id="L298">            .trim();  // trim spaces in '${binary.mode} ${test}' when no mode, not covered by cleanSql()</span>
    }

    @Override
    public String sqlBlindBin(String inj, int indexChar, int mid, BlindOperator blindOperator) {
<span class="fc" id="L303">        String replacement = this.getMode(blindOperator);</span>
<span class="fc" id="L304">        return this.modelYaml.getStrategy().getBinary().getBlind()</span>
<span class="fc" id="L305">            .replace(EngineYaml.BINARY_MODE, replacement)</span>
<span class="fc" id="L306">            .replace(</span>
                EngineYaml.TEST,
<span class="fc" id="L308">                this.modelYaml.getStrategy().getBinary().getTest().getBin()</span>
<span class="fc" id="L309">                .replace(EngineYaml.INJECTION, inj)</span>
<span class="fc" id="L310">                .replace(EngineYaml.WINDOW_CHAR, Integer.toString(indexChar))</span>
<span class="fc" id="L311">                .replace(</span>
                    EngineYaml.MID_CHR,
<span class="fc" id="L313">                    StringUtil.toUrl(Character.toString((char) mid).replace(&quot;'&quot;, &quot;''&quot;))  // escape quote</span>
                )
<span class="fc" id="L315">                .replace(EngineYaml.MID_INT, String.valueOf(mid))</span>
            )
<span class="fc" id="L317">            .trim();  // trim spaces in '${binary.mode} ${test}' when no mode, not covered by cleanSql()</span>
    }

    @Override
    public String sqlTestTimeWithOperator(String check, BlindOperator blindOperator) {
<span class="fc" id="L322">        String replacement = this.getMode(blindOperator);</span>
<span class="pc bpc" id="L323" title="1 of 2 branches missed.">        int countSleepTimeStrategy = this.injectionModel.getMediatorUtils().preferencesUtil().isLimitingSleepTimeStrategy()</span>
<span class="nc" id="L324">            ? this.injectionModel.getMediatorUtils().preferencesUtil().countSleepTimeStrategy()</span>
<span class="fc" id="L325">            : 5;</span>
<span class="fc" id="L326">        return this.modelYaml.getStrategy().getBinary().getTime()</span>
<span class="fc" id="L327">            .replace(EngineYaml.BINARY_MODE, replacement)</span>
<span class="fc" id="L328">            .replace(EngineYaml.TEST, check)</span>
<span class="fc" id="L329">            .replace(EngineYaml.SLEEP_TIME, Long.toString(countSleepTimeStrategy))</span>
<span class="fc" id="L330">            .trim();  // trim spaces in '${binary.mode} ${test}' when no mode, not covered by cleanSql()</span>
    }

    @Override
    public String sqlTimeBit(String inj, int indexChar, int bit, BlindOperator blindOperator) {
<span class="fc" id="L335">        String replacement = this.getMode(blindOperator);</span>
<span class="pc bpc" id="L336" title="1 of 2 branches missed.">        int countSleepTimeStrategy = this.injectionModel.getMediatorUtils().preferencesUtil().isLimitingSleepTimeStrategy()</span>
<span class="nc" id="L337">            ? this.injectionModel.getMediatorUtils().preferencesUtil().countSleepTimeStrategy()</span>
<span class="fc" id="L338">            : 5;</span>
<span class="fc" id="L339">        return this.modelYaml.getStrategy().getBinary().getTime()</span>
<span class="fc" id="L340">            .replace(EngineYaml.BINARY_MODE, replacement)</span>
<span class="fc" id="L341">            .replace(</span>
                EngineYaml.TEST,
<span class="fc" id="L343">                this.modelYaml.getStrategy().getBinary().getTest()</span>
<span class="fc" id="L344">                .getBit()</span>
<span class="fc" id="L345">                .replace(EngineYaml.INJECTION, inj)</span>
<span class="fc" id="L346">                .replace(EngineYaml.WINDOW_CHAR, Integer.toString(indexChar))</span>
<span class="fc" id="L347">                .replace(EngineYaml.BIT, Integer.toString(bit))</span>
            )
<span class="fc" id="L349">            .replace(EngineYaml.SLEEP_TIME, Long.toString(countSleepTimeStrategy))</span>
<span class="fc" id="L350">            .trim();  // trim spaces in '${binary.mode} ${test}' when no mode, not covered by cleanSql()</span>
    }

    private String getMode(BlindOperator blindOperator) {
<span class="fc bfc" id="L354" title="All 4 branches covered.">        return switch (blindOperator) {</span>
<span class="fc" id="L355">            case AND -&gt; this.modelYaml.getStrategy().getBinary().getModeAnd();</span>
<span class="fc" id="L356">            case OR -&gt; this.modelYaml.getStrategy().getBinary().getModeOr();</span>
<span class="fc" id="L357">            case STACK -&gt; this.modelYaml.getStrategy().getBinary().getModeStack();</span>
<span class="fc" id="L358">            default -&gt; StringUtils.EMPTY;</span>
        };
    }

    @Override
    public String sqlBlind(String sqlQuery, String startPosition, boolean isReport) {
<span class="fc" id="L364">        return EngineYaml.replaceTags(</span>
<span class="fc" id="L365">            this.getSlidingWindow(isReport)</span>
<span class="fc" id="L366">            .replace(EngineYaml.INJECTION, sqlQuery)</span>
<span class="fc" id="L367">            .replace(EngineYaml.WINDOW_CHAR, startPosition)</span>
<span class="fc" id="L368">            .replace(EngineYaml.CAPACITY, EngineYaml.DEFAULT_CAPACITY)</span>
        );
    }

    @Override
    public String sqlTime(String sqlQuery, String startPosition, boolean isReport) {
<span class="fc" id="L374">        return EngineYaml.replaceTags(</span>
<span class="fc" id="L375">            this.getSlidingWindow(isReport)</span>
<span class="fc" id="L376">            .replace(EngineYaml.INJECTION, sqlQuery)</span>
<span class="fc" id="L377">            .replace(EngineYaml.WINDOW_CHAR, startPosition)</span>
<span class="fc" id="L378">            .replace(EngineYaml.CAPACITY, EngineYaml.DEFAULT_CAPACITY)</span>
        );
    }

    @Override
    public String sqlMultibit(String inj, int indexChar, int block){
<span class="fc" id="L384">        return this.modelYaml.getStrategy().getBinary().getMultibit()</span>
<span class="fc" id="L385">            .replace(EngineYaml.INJECTION, inj)</span>
<span class="fc" id="L386">            .replace(EngineYaml.WINDOW_CHAR, Integer.toString(indexChar))</span>
<span class="fc" id="L387">            .replace(EngineYaml.BLOCK_MULTIBIT, Integer.toString(block));</span>
    }

    @Override
    public String sqlErrorCalibrator(Method errorMethod) {
<span class="fc" id="L392">        return EngineYaml.replaceTags(</span>
<span class="fc" id="L393">            errorMethod.getQuery()</span>
<span class="fc" id="L394">            .replace(EngineYaml.WINDOW, this.modelYaml.getStrategy().getConfiguration().getSlidingWindow())</span>
<span class="fc" id="L395">            .replace(EngineYaml.INJECTION, this.modelYaml.getStrategy().getConfiguration().getCalibrator())</span>
<span class="fc" id="L396">            .replace(EngineYaml.WINDOW_CHAR, &quot;1&quot;)</span>
<span class="fc" id="L397">            .replace(EngineYaml.CAPACITY, Integer.toString(errorMethod.getCapacity()))</span>
        );
    }

    @Override
    public String sqlErrorIndice(Method errorMethod) {
<span class="fc" id="L403">        var indexZeroToFind = &quot;0&quot;;</span>
<span class="fc" id="L404">        return EngineYaml.replaceTags(</span>
<span class="fc" id="L405">            errorMethod.getQuery()</span>
<span class="fc" id="L406">            .replace(EngineYaml.WINDOW, this.modelYaml.getStrategy().getConfiguration().getSlidingWindow())</span>
<span class="fc" id="L407">            .replace(EngineYaml.INJECTION, this.modelYaml.getStrategy().getConfiguration().getFailsafe().replace(EngineYaml.INDICE, indexZeroToFind))</span>
<span class="fc" id="L408">            .replace(EngineYaml.WINDOW_CHAR, &quot;1&quot;)</span>
<span class="fc" id="L409">            .replace(EngineYaml.CAPACITY, Integer.toString(errorMethod.getCapacity()))</span>
        );
    }

    @Override
    public String sqlError(String sqlQuery, String startPosition, int indexMethodError, boolean isReport) {
<span class="fc" id="L415">        return EngineYaml.replaceTags(</span>
<span class="fc" id="L416">            this.modelYaml.getStrategy().getError().getMethod().get(indexMethodError).getQuery()</span>
<span class="fc" id="L417">            .replace(EngineYaml.WINDOW, this.getSlidingWindow(isReport))</span>
<span class="fc" id="L418">            .replace(EngineYaml.INJECTION, sqlQuery)</span>
<span class="fc" id="L419">            .replace(EngineYaml.WINDOW_CHAR, startPosition)</span>
<span class="fc" id="L420">            .replace(</span>
                EngineYaml.CAPACITY,
<span class="fc" id="L422">                Integer.toString(</span>
<span class="fc" id="L423">                    this.modelYaml.getStrategy().getError()</span>
<span class="fc" id="L424">                    .getMethod()</span>
<span class="fc" id="L425">                    .get(indexMethodError)</span>
<span class="fc" id="L426">                    .getCapacity()</span>
                )
            )
        );
    }

    @Override
    public String sqlUnion(String sqlQuery, String startPosition, boolean isReport) {
<span class="fc" id="L434">        return EngineYaml.replaceTags(</span>
<span class="fc" id="L435">            this.getSlidingWindow(isReport)</span>
<span class="fc" id="L436">            .replace(EngineYaml.INJECTION, sqlQuery)</span>
<span class="fc" id="L437">            .replace(EngineYaml.WINDOW_CHAR, startPosition)</span>
<span class="fc" id="L438">            .replace(EngineYaml.CAPACITY, this.injectionModel.getMediatorStrategy().getUnion().getPerformanceLength())</span>
        );
    }

    @Override
    public String sqlDns(String sqlQuery, String startPosition, BlindOperator blindOperator, boolean isReport) {
<span class="nc" id="L444">        String replacement = this.getMode(blindOperator);</span>
<span class="nc" id="L445">        String result = EngineYaml.replaceTags(</span>
<span class="nc" id="L446">            this.modelYaml.getStrategy().getDns()</span>
<span class="nc" id="L447">            .replace(EngineYaml.WINDOW, this.getSlidingWindow(isReport))</span>
<span class="nc" id="L448">            .replace(EngineYaml.BINARY_MODE, replacement)</span>
<span class="nc" id="L449">            .replace(EngineYaml.INJECTION, sqlQuery)</span>
<span class="nc" id="L450">            .replace(EngineYaml.DNS_DOMAIN, this.injectionModel.getMediatorUtils().preferencesUtil().getDnsDomain())</span>
<span class="nc" id="L451">            .replace(EngineYaml.WINDOW_CHAR, startPosition)</span>
<span class="nc" id="L452">            .replace(EngineYaml.CAPACITY, EngineYaml.DEFAULT_CAPACITY)</span>
        );
<span class="nc" id="L454">        return Pattern.compile(Pattern.quote(EngineYaml.DNS_RANDOM))</span>
<span class="nc" id="L455">            .matcher(result)</span>
<span class="nc" id="L456">            .replaceAll(m -&gt; String.format(&quot;%03d&quot;, ThreadLocalRandom.current().nextInt(999)));</span>
    }

    @Override
    public String sqlStack(String sqlQuery, String startPosition, boolean isReport) {
<span class="fc" id="L461">        return this.modelYaml.getStrategy().getStack().replace(</span>
            EngineYaml.WINDOW,
<span class="fc" id="L463">            EngineYaml.replaceTags(</span>
<span class="fc" id="L464">                this.getSlidingWindow(isReport)</span>
<span class="fc" id="L465">                .replace(EngineYaml.INJECTION, sqlQuery)</span>
<span class="fc" id="L466">                .replace(EngineYaml.WINDOW_CHAR, startPosition)</span>
<span class="fc" id="L467">                .replace(EngineYaml.CAPACITY, EngineYaml.DEFAULT_CAPACITY)</span>
            )
        );
    }

    @Override
    public String sqlCapacity(String[] indexes) {
<span class="fc" id="L474">        String regexIndexes = String.join(&quot;|&quot;, indexes);</span>
<span class="fc" id="L475">        String regexVisibleIndexesToFind = String.format(EngineYaml.FORMAT_INDEX, &quot;(%s)&quot;);</span>
<span class="fc" id="L476">        return this.injectionModel.getMediatorStrategy().getSpecificUnion().getIndexesInUrl().replaceAll(</span>
<span class="fc" id="L477">            String.format(regexVisibleIndexesToFind, regexIndexes),</span>
<span class="fc" id="L478">            EngineYaml.replaceTags(</span>
<span class="fc" id="L479">                this.modelYaml.getStrategy().getUnion().getCapacity()</span>
<span class="fc" id="L480">                .replace(EngineYaml.CALIBRATOR, this.modelYaml.getStrategy().getConfiguration().getCalibrator())</span>
<span class="fc" id="L481">                .replace(EngineYaml.INDICE, &quot;$1&quot;)</span>
            )
        );
    }

    @Override
    public String sqlIndices(Integer nbFields) {
<span class="fc" id="L488">        String replaceTag = StringUtils.EMPTY;</span>
<span class="fc" id="L489">        List&lt;String&gt; fields = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L490">        var indice = 1;</span>
<span class="fc bfc" id="L491" title="All 2 branches covered.">        for ( ; indice &lt;= nbFields ; indice++) {</span>
<span class="fc" id="L492">            String field = this.modelYaml.getStrategy().getConfiguration().getFailsafe().replace(EngineYaml.INDICE, Integer.toString(indice));</span>
<span class="fc" id="L493">            fields.add(field);</span>
<span class="fc" id="L494">            replaceTag = field;</span>
        }
<span class="fc" id="L496">        indice--;</span>
<span class="fc" id="L497">        return this.modelYaml.getStrategy().getUnion()</span>
<span class="fc" id="L498">            .getIndices()</span>
<span class="fc" id="L499">            .replace(</span>
                EngineYaml.INDICES,
<span class="fc" id="L501">                String.join(&quot;,&quot;, fields.toArray(new String[0]))</span>
            )
<span class="fc" id="L503">            .replace(EngineYaml.INDICE_UNIQUE, replaceTag)</span>
<span class="fc" id="L504">            .replace(</span>
                EngineYaml.RESULT_RANGE,
<span class="fc" id="L506">                String.join(&quot;,&quot;, Collections.nCopies(indice, &quot;r&quot;))</span>
            );
    }

    @Override
    public String sqlLimit(Integer limitSqlResult) {
<span class="fc" id="L512">        var limitBoundary = 0;</span>
        try {
<span class="fc" id="L514">            limitBoundary = Integer.parseInt(this.modelYaml.getStrategy().getConfiguration().getLimitBoundary());</span>
<span class="nc" id="L515">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L516">            LOGGER.log(LogLevelUtil.CONSOLE_ERROR, &quot;Incorrect Limit start index, force to 0&quot;);</span>
<span class="fc" id="L517">        }</span>
<span class="fc" id="L518">        return this.modelYaml.getStrategy().getConfiguration()</span>
<span class="fc" id="L519">            .getLimit()</span>
<span class="fc" id="L520">            .replace(EngineYaml.LIMIT_VALUE, Integer.toString(limitSqlResult + limitBoundary));</span>
    }
    
    @Override
    public String fingerprintErrorsAsRegex() {
<span class="fc" id="L525">        return &quot;(?si)&quot;+ StringUtils.join(</span>
<span class="fc" id="L526">            this.modelYaml.getStrategy().getConfiguration().getFingerprint()</span>
<span class="fc" id="L527">            .getErrorMessage()</span>
<span class="fc" id="L528">            .stream()</span>
<span class="fc" id="L529">            .map(m -&gt; &quot;.*&quot;+ m +&quot;.*&quot;)</span>
<span class="fc" id="L530">            .toArray(),</span>
            &quot;|&quot;
        );
    }
    
    public static String replaceTags(String sqlRequest) {
<span class="fc" id="L536">        return sqlRequest</span>
<span class="fc" id="L537">            .replace(&quot;${enclose_value_sql}&quot;, EngineYaml.ENCLOSE_VALUE_SQL)</span>
<span class="fc" id="L538">            .replace(&quot;${enclose_value_hex}&quot;, EngineYaml.ENCLOSE_VALUE_HEX)</span>
<span class="fc" id="L539">            .replace(&quot;${separator_qte_sql}&quot;, EngineYaml.SEPARATOR_QTE_SQL)</span>
<span class="fc" id="L540">            .replace(&quot;${separator_qte_hex}&quot;, EngineYaml.SEPARATOR_QTE_HEX)</span>
<span class="fc" id="L541">            .replace(&quot;${separator_cell_sql}&quot;, EngineYaml.SEPARATOR_CELL_SQL)</span>
<span class="fc" id="L542">            .replace(&quot;${separator_cell_hex}&quot;, EngineYaml.SEPARATOR_CELL_HEX)</span>
<span class="fc" id="L543">            .replace(&quot;${calibrator_sql}&quot;, EngineYaml.CALIBRATOR_SQL)</span>
<span class="fc" id="L544">            .replace(&quot;${calibrator_raw}&quot;, EngineYaml.CALIBRATOR_SQL.repeat(100))</span>
<span class="fc" id="L545">            .replace(&quot;${calibrator_hex}&quot;, EngineYaml.CALIBRATOR_HEX)</span>
<span class="fc" id="L546">            .replace(&quot;${trail_sql}&quot;, EngineYaml.TRAIL_SQL)</span>
<span class="fc" id="L547">            .replace(&quot;${trail_hex}&quot;, EngineYaml.TRAIL_HEX)</span>
<span class="fc" id="L548">            .replace(&quot;${lead}&quot;, LEAD)</span>
<span class="fc" id="L549">            .replace(&quot;${lead_hex}&quot;, EngineYaml.LEAD_HEX)</span>
<span class="fc" id="L550">            .replace(&quot;${lead_pipe}&quot;, EngineYaml.LEAD_PIPE);</span>
    }

    /**
     * Get payload with sliding window except for vulnerability report
     */
    private String getSlidingWindow(boolean isReport) {
<span class="fc bfc" id="L557" title="All 2 branches covered.">        return isReport</span>
<span class="fc" id="L558">            ? &quot;(&quot; + EngineYaml.INJECTION + &quot;)&quot;</span>
<span class="fc" id="L559">            : this.modelYaml.getStrategy().getConfiguration().getSlidingWindow();</span>
    }
    
    
    // Getter and setter

    @Override
    public String sqlInfos() {
<span class="fc" id="L567">        return this.modelYaml.getResource().getInfo();</span>
    }

    @Override
    public List&lt;String&gt; getFalsyBit() {
<span class="fc" id="L572">        return this.modelYaml.getStrategy().getBinary().getTest().getFalsyBit();</span>
    }

    @Override
    public List&lt;String&gt; getTruthyBit() {
<span class="fc" id="L577">        return this.modelYaml.getStrategy().getBinary().getTest().getTruthyBit();</span>
    }

    @Override
    public List&lt;String&gt; getFalsyBin() {
<span class="fc" id="L582">        return this.modelYaml.getStrategy().getBinary().getTest().getFalsyBin();</span>
    }

    @Override
    public List&lt;String&gt; getTruthyBin() {
<span class="fc" id="L587">        return this.modelYaml.getStrategy().getBinary().getTest().getTruthyBin();</span>
    }

    @Override
    public String sqlBlindConfirm() {
<span class="fc" id="L592">        return this.modelYaml.getStrategy().getBinary().getTest().getInit();</span>
    }

    @Override
    public String sqlOrderBy() {
<span class="fc" id="L597">        return this.modelYaml.getStrategy().getUnion().getOrderBy();</span>
    }
    
    @Override
    public String endingComment() {
<span class="fc bfc" id="L602" title="All 2 branches covered.">        if (this.injectionModel.getMediatorUtils().preferencesUtil().isUrlRandomSuffixDisabled()) {</span>
<span class="fc" id="L603">            return this.modelYaml.getStrategy().getConfiguration().getEndingComment();</span>
        } else {
<span class="fc" id="L605">            return this.modelYaml.getStrategy().getConfiguration().getEndingComment()</span>
<span class="fc" id="L606">                + RandomStringUtils.secure().nextAlphanumeric(4);  // Allows binary match fingerprinting on host errors</span>
        }
    }

    @Override
    public ModelYaml getModelYaml() {
<span class="fc" id="L612">        return this.modelYaml;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>