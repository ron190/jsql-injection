<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MediatorStrategy.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">model</a> &gt; <a href="index.source.html" class="el_package">com.jsql.model.injection.strategy</a> &gt; <span class="el_source">MediatorStrategy.java</span></div><h1>MediatorStrategy.java</h1><pre class="source lang-java linenums">package com.jsql.model.injection.strategy;

import com.jsql.model.InjectionModel;
import com.jsql.model.exception.JSqlException;
import com.jsql.model.injection.vendor.model.VendorYaml;
import com.jsql.model.suspendable.SuspendableGetCharInsertion;
import com.jsql.model.suspendable.SuspendableGetVendor;
import com.jsql.util.LogLevelUtil;
import com.jsql.util.StringUtil;
import org.apache.commons.lang3.StringUtils;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

import java.util.AbstractMap.SimpleEntry;
import java.util.Arrays;
import java.util.List;
import java.util.regex.Matcher;

public class MediatorStrategy {

<span class="fc" id="L21">    private static final Logger LOGGER = LogManager.getRootLogger();</span>
    
    private final AbstractStrategy time;
    private final AbstractStrategy blindBit;
    private final AbstractStrategy blindBin;
    private final AbstractStrategy multibit;
    private final StrategyError error;
    private final AbstractStrategy union;
    private final AbstractStrategy stack;

    private final List&lt;AbstractStrategy&gt; strategies;
    
    /**
     * Current injection strategy.
     */
    private AbstractStrategy strategy;

    private final InjectionModel injectionModel;
    
<span class="fc" id="L40">    public MediatorStrategy(InjectionModel injectionModel) {</span>
<span class="fc" id="L41">        this.injectionModel = injectionModel;</span>
        
<span class="fc" id="L43">        this.time = new StrategyTime(this.injectionModel);</span>
<span class="fc" id="L44">        this.blindBit = new StrategyBlindBit(this.injectionModel);</span>
<span class="fc" id="L45">        this.blindBin = new StrategyBlindBin(this.injectionModel);</span>
<span class="fc" id="L46">        this.multibit = new StrategyMultibit(this.injectionModel);</span>
<span class="fc" id="L47">        this.error = new StrategyError(this.injectionModel);</span>
<span class="fc" id="L48">        this.union = new StrategyUnion(this.injectionModel);</span>
<span class="fc" id="L49">        this.stack = new StrategyStack(this.injectionModel);</span>

<span class="fc" id="L51">        this.strategies = Arrays.asList(this.time, this.blindBin, this.blindBit, this.multibit, this.error, this.stack, this.union);</span>
<span class="fc" id="L52">    }</span>
    
    public String getMeta() {
<span class="fc bfc" id="L55" title="All 2 branches covered.">        String strategyName = this.strategy == null ? StringUtils.EMPTY : this.strategy.toString().toLowerCase();</span>
<span class="fc" id="L56">        var strategyMode = &quot;default&quot;;</span>
<span class="fc bfc" id="L57" title="All 2 branches covered.">        if (this.injectionModel.getMediatorUtils().getPreferencesUtil().isDiosStrategy()) {</span>
<span class="fc" id="L58">            strategyMode = &quot;dios&quot;;</span>
<span class="fc bfc" id="L59" title="All 2 branches covered.">        } else if (this.injectionModel.getMediatorUtils().getPreferencesUtil().isZipStrategy()) {</span>
<span class="fc" id="L60">            strategyMode = &quot;zip&quot;;</span>
        }
<span class="fc" id="L62">        return String.format(&quot;%s#%s&quot;, strategyName.replace(&quot; &quot;, &quot;-&quot;), strategyMode);</span>
    }
    
    /**
     * Build correct data for GET, POST, HEADER.
     * Each can be either raw data (no injection), SQL query without index requirement,
     * or SQL query with index requirement.
     * @param urlBase Beginning of the request data
     * @param isUsingIndex False if request doesn't use indexes
     * @param sqlTrail SQL statement
     * @return Final data
     */
    public String buildPath(String urlBase, boolean isUsingIndex, String sqlTrail) {
<span class="fc" id="L75">        String result = urlBase;</span>
<span class="fc bfc" id="L76" title="All 2 branches covered.">        if (urlBase.contains(InjectionModel.STAR)) {</span>
<span class="fc bfc" id="L77" title="All 2 branches covered.">            if (!isUsingIndex) {</span>
<span class="fc" id="L78">                result = urlBase.replace(InjectionModel.STAR, this.encodePath(sqlTrail));</span>
            } else {
<span class="fc" id="L80">                result = urlBase.replace(</span>
                    InjectionModel.STAR,
<span class="fc" id="L82">                    this.encodePath(</span>
<span class="fc" id="L83">                        this.injectionModel.getIndexesInUrl().replaceAll(</span>
<span class="fc" id="L84">                            String.format(VendorYaml.FORMAT_INDEX, this.getSpecificUnion().getVisibleIndex()),</span>
<span class="fc" id="L85">                            Matcher.quoteReplacement(sqlTrail)  // Oracle column can contain regex char $ =&gt; quoteReplacement()</span>
                        )
                    )
                );
            }
        }
<span class="fc" id="L91">        return result;</span>
    }

    private String encodePath(String sqlTrail) {
<span class="fc" id="L95">        String sqlTrailEncoded = StringUtil.cleanSql(sqlTrail);</span>

<span class="pc bpc" id="L97" title="1 of 2 branches missed.">        if (!this.injectionModel.getMediatorUtils().getPreferencesUtil().isUrlEncodingDisabled()) {</span>
<span class="fc" id="L98">            sqlTrailEncoded = sqlTrailEncoded</span>
<span class="fc" id="L99">                .replace(&quot;'&quot;, &quot;%27&quot;)</span>
<span class="fc" id="L100">                .replace(&quot;(&quot;, &quot;%28&quot;)</span>
<span class="fc" id="L101">                .replace(&quot;)&quot;, &quot;%29&quot;)</span>
<span class="fc" id="L102">                .replace(&quot;{&quot;, &quot;%7b&quot;)</span>
<span class="fc" id="L103">                .replace(&quot;[&quot;, &quot;%5b&quot;)</span>
<span class="fc" id="L104">                .replace(&quot;]&quot;, &quot;%5d&quot;)</span>
<span class="fc" id="L105">                .replace(&quot;}&quot;, &quot;%7d&quot;)</span>
<span class="fc" id="L106">                .replace(&quot;&gt;&quot;, &quot;%3e&quot;)</span>
<span class="fc" id="L107">                .replace(&quot;&lt;&quot;, &quot;%3c&quot;)</span>
<span class="fc" id="L108">                .replace(&quot;?&quot;, &quot;%3f&quot;)</span>
<span class="fc" id="L109">                .replace(&quot;_&quot;, &quot;%5f&quot;)</span>
<span class="fc" id="L110">                .replace(&quot;\\&quot;, &quot;%5c&quot;)</span>
<span class="fc" id="L111">                .replace(&quot;,&quot;, &quot;%2c&quot;);</span>
        }

        // URL forbidden characters
<span class="fc" id="L115">        return (sqlTrailEncoded + this.injectionModel.getMediatorVendor().getVendor().instance().endingComment())</span>
<span class="fc" id="L116">            .replace(&quot;\&quot;&quot;, &quot;%22&quot;)</span>
<span class="fc" id="L117">            .replace(&quot;|&quot;, &quot;%7c&quot;)</span>
<span class="fc" id="L118">            .replace(&quot;`&quot;, &quot;%60&quot;)</span>
<span class="fc" id="L119">            .replace(StringUtils.SPACE, &quot;%20&quot;)</span>
<span class="fc" id="L120">            .replace(&quot;+&quot;, &quot;%20&quot;);</span>
    }
    
    /**
     * Find the insertion character, test each strategy, inject metadata and list databases.
     * @param parameterToInject to be tested, null when injection point
     * @return true when successful injection
     * @throws JSqlException when no params integrity, process stopped by user, or injection failure
     */
    public boolean testStrategies(SimpleEntry&lt;String, String&gt; parameterToInject) throws JSqlException {
        // Define insertionCharacter, i.e, -1 in &quot;[..].php?id=-1 union select[..]&quot;,
        
<span class="fc" id="L132">        String parameterOriginalValue = null;</span>
        
        // Fingerprint database
<span class="fc" id="L135">        this.injectionModel.getMediatorVendor().setVendor(this.injectionModel.getMediatorVendor().fingerprintVendor());</span>
        
        // If not an injection point then find insertion character.
        // Force to 1 if no insertion char works and empty value from user,
        // Force to user's value if no insertion char works,
        // Force to insertion char otherwise.
        // parameterToInject null on true STAR injection
        // TODO Use also on Json injection where parameter == null
<span class="fc bfc" id="L143" title="All 2 branches covered.">        if (parameterToInject != null) {</span>
<span class="fc" id="L144">            parameterOriginalValue = parameterToInject.getValue();</span>
                     
            // Test for params integrity
<span class="fc" id="L147">            String characterInsertionByUser = this.injectionModel.getMediatorUtils().getParameterUtil().initStar(parameterToInject);</span>
            
<span class="fc bfc" id="L149" title="All 2 branches covered.">            String characterInsertion = this.injectionModel.getMediatorUtils().getPreferencesUtil().isNotSearchingCharInsertion()</span>
<span class="fc" id="L150">                ? characterInsertionByUser</span>
<span class="fc" id="L151">                : new SuspendableGetCharInsertion(this.injectionModel).run(characterInsertionByUser);</span>
<span class="fc bfc" id="L152" title="All 2 branches covered.">            if (characterInsertion.contains(InjectionModel.STAR)) {  // When injecting all parameters or JSON</span>
<span class="fc" id="L153">                parameterToInject.setValue(characterInsertion);</span>
            } else {  // When injecting last parameter
<span class="fc" id="L155">                parameterToInject.setValue(characterInsertion.replaceAll(&quot;(\\w)$&quot;, &quot;$1+&quot;) + InjectionModel.STAR);</span>
            }
<span class="fc bfc" id="L157" title="All 2 branches covered.">        } else if (this.injectionModel.getMediatorUtils().getConnectionUtil().getUrlBase().contains(InjectionModel.STAR)) {</span>
<span class="fc" id="L158">            String characterInsertion = new SuspendableGetCharInsertion(this.injectionModel).run(StringUtils.EMPTY);</span>
<span class="fc" id="L159">            String urlBase = this.injectionModel.getMediatorUtils().getConnectionUtil().getUrlBase();</span>
<span class="fc" id="L160">            this.injectionModel.getMediatorUtils().getConnectionUtil().setUrlBase(</span>
                // Space %20 for URL, do not use +
<span class="fc" id="L162">                urlBase.replace(InjectionModel.STAR, characterInsertion.replaceAll(&quot;(\\w)$&quot;, &quot;$1%20&quot;) + InjectionModel.STAR)</span>
            );
        }

<span class="fc bfc" id="L166" title="All 2 branches covered.">        if (this.injectionModel.getMediatorVendor().getVendorByUser() == this.injectionModel.getMediatorVendor().getAuto()) {</span>
<span class="fc" id="L167">            new SuspendableGetVendor(this.injectionModel).run();</span>
        }

        // Test each injection strategies: time &lt; blind binary &lt; blind bitwise &lt; multibit &lt; error &lt; stack &lt; union
<span class="fc" id="L171">        this.time.checkApplicability();</span>
<span class="fc" id="L172">        this.blindBin.checkApplicability();</span>
<span class="fc" id="L173">        this.blindBit.checkApplicability();</span>

<span class="fc bfc" id="L175" title="All 2 branches covered.">        if (parameterToInject != null) {</span>
            // Multibit requires '0'
            // TODO char insertion 0' should also work on &quot;where x='$param'&quot;
<span class="fc" id="L178">            var backupCharacterInsertion = parameterToInject.getValue();</span>
<span class="fc" id="L179">            parameterToInject.setValue(InjectionModel.STAR);</span>
<span class="fc" id="L180">            this.multibit.checkApplicability();</span>
<span class="fc" id="L181">            parameterToInject.setValue(backupCharacterInsertion);</span>
<span class="fc" id="L182">        } else {</span>
<span class="fc" id="L183">            this.multibit.checkApplicability();</span>
        }

<span class="fc" id="L186">        this.error.checkApplicability();</span>
<span class="fc" id="L187">        this.stack.checkApplicability();</span>
<span class="fc" id="L188">        this.union.checkApplicability();</span>

        // Set most efficient strategy first: union &gt; stack &gt; error &gt; multibit &gt; blind bitwise &gt; blind binary &gt; time
<span class="fc" id="L191">        this.union.activateWhenApplicable();</span>
<span class="fc" id="L192">        this.stack.activateWhenApplicable();</span>
<span class="fc" id="L193">        this.error.activateWhenApplicable();</span>
<span class="fc" id="L194">        this.multibit.activateWhenApplicable();</span>
<span class="fc" id="L195">        this.blindBit.activateWhenApplicable();</span>
<span class="fc" id="L196">        this.blindBin.activateWhenApplicable();</span>
<span class="fc" id="L197">        this.time.activateWhenApplicable();</span>

<span class="fc bfc" id="L199" title="All 2 branches covered.">        if (this.injectionModel.getMediatorStrategy().getStrategy() == null) {  // no strategy found</span>
            // Restore initial parameter value on injection failure
            // Only when not true STAR injection
<span class="pc bpc" id="L202" title="1 of 2 branches missed.">            if (parameterOriginalValue != null) {</span>
<span class="fc" id="L203">                parameterToInject.setValue(parameterOriginalValue.replace(InjectionModel.STAR, StringUtils.EMPTY));</span>
            }

<span class="fc" id="L206">            LOGGER.log(LogLevelUtil.CONSOLE_ERROR, &quot;No injection found&quot;);</span>
<span class="fc" id="L207">            return false;</span>
        }
        
<span class="fc" id="L210">        return true;</span>
    }
    
    
    // Getter and setter

    public AbstractStrategy getUnion() {
<span class="fc" id="L217">        return this.union;</span>
    }

    public StrategyUnion getSpecificUnion() {
<span class="fc" id="L221">        return (StrategyUnion) this.union;</span>
    }

    public StrategyError getError() {
<span class="fc" id="L225">        return this.error;</span>
    }

    public AbstractStrategy getBlindBit() {
<span class="fc" id="L229">        return this.blindBit;</span>
    }

    public AbstractStrategy getBlindBin() {
<span class="fc" id="L233">        return this.blindBin;</span>
    }

    public AbstractStrategy getMultibit() {
<span class="fc" id="L237">        return this.multibit;</span>
    }

    public AbstractStrategy getTime() {
<span class="fc" id="L241">        return this.time;</span>
    }

    public AbstractStrategy getStack() {
<span class="fc" id="L245">        return this.stack;</span>
    }

    public List&lt;AbstractStrategy&gt; getStrategies() {
<span class="nc" id="L249">        return this.strategies;</span>
    }

    public AbstractStrategy getStrategy() {
<span class="fc" id="L253">        return this.strategy;</span>
    }

    public void setStrategy(AbstractStrategy strategy) {
<span class="fc" id="L257">        this.strategy = strategy;</span>
<span class="fc" id="L258">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>