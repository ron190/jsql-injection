<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AdjusterTableColumn.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">view</a> &gt; <a href="index.source.html" class="el_package">com.jsql.view.swing.table</a> &gt; <span class="el_source">AdjusterTableColumn.java</span></div><h1>AdjusterTableColumn.java</h1><pre class="source lang-java linenums">package com.jsql.view.swing.table;

import javax.swing.*;
import javax.swing.event.TableModelEvent;
import javax.swing.event.TableModelListener;
import javax.swing.table.TableCellRenderer;
import javax.swing.table.TableColumn;
import javax.swing.table.TableColumnModel;
import javax.swing.table.TableModel;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.beans.PropertyChangeEvent;
import java.beans.PropertyChangeListener;
import java.util.HashMap;
import java.util.Map;

/**
 * Class to manage the widths of columns in a table.
 *
 * Various properties control how the width of the column is calculated.
 * Another property controls whether column width calculation should be dynamic.
 * Finally, various Actions will be added to the table to allow the user
 * to customize the functionality.
 *
 * This class was designed to be used with tables that use an auto resize mode
 * of AUTO_RESIZE_OFF. With all other modes you are constrained as the width
 * of the columns must fit inside the table. So if you increase one column, one
 * or more of the other columns must decrease. Because of this the resize mode
 * of RESIZE_ALL_COLUMNS will work the best.
 */
public class AdjusterTableColumn implements PropertyChangeListener, TableModelListener {
    
    private final JTable tableAdjust;
    private final int spacing;
    private boolean isColumnHeaderIncluded;
    private boolean isColumnDataIncluded;
    private boolean isOnlyAdjustLarger;
    private boolean isDynamicAdjustment;
<span class="fc" id="L39">    private final Map&lt;TableColumn, Integer&gt; columnSizes = new HashMap&lt;&gt;();</span>

    /**
     * Specify the table and use default spacing
     */
    public AdjusterTableColumn(JTable table) {
<span class="fc" id="L45">        this(table, 6);</span>
<span class="fc" id="L46">    }</span>

    /**
     * Specify the table and spacing
     */
<span class="fc" id="L51">    public AdjusterTableColumn(JTable tableAdjust, int spacing) {</span>
<span class="fc" id="L52">        this.tableAdjust = tableAdjust;</span>
<span class="fc" id="L53">        this.spacing = spacing;</span>
<span class="fc" id="L54">        this.setColumnHeaderIncluded(true);</span>
<span class="fc" id="L55">        this.setColumnDataIncluded(true);</span>
<span class="fc" id="L56">        this.setOnlyAdjustLarger(true);</span>
<span class="fc" id="L57">        this.setDynamicAdjustment(false);</span>
<span class="fc" id="L58">        this.installActions();</span>
<span class="fc" id="L59">    }</span>

    /**
     * Adjust the widths of all the columns in the table
     */
    public void adjustColumns() {
<span class="fc" id="L65">        TableColumnModel tcm = this.tableAdjust.getColumnModel();</span>
<span class="fc bfc" id="L66" title="All 2 branches covered.">        for (var i = 0 ; i &lt; tcm.getColumnCount() ; i++) {</span>
<span class="fc" id="L67">            this.adjustColumn(i);</span>
        }
<span class="fc" id="L69">    }</span>

    /**
     * Adjust the width of the specified column in the table
     */
    public void adjustColumn(final int column) {
<span class="fc" id="L75">        var tableColumn = this.tableAdjust.getColumnModel().getColumn(column);</span>
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">        if (!tableColumn.getResizable()) {</span>
<span class="nc" id="L77">            return;</span>
        }

<span class="fc" id="L80">        int columnHeaderWidth = this.getColumnHeaderWidth(column);</span>
<span class="fc" id="L81">        int columnDataWidth   = this.getColumnDataWidth(column);</span>
<span class="fc" id="L82">        int preferredWidth    = Math.max(columnHeaderWidth, columnDataWidth);</span>
<span class="fc" id="L83">        this.updateTableColumn(column, preferredWidth);</span>
<span class="fc" id="L84">    }</span>

    /**
     * Calculated the width based on the column name
     */
    private int getColumnHeaderWidth(int column) {
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">        if (!this.isColumnHeaderIncluded) {</span>
<span class="nc" id="L91">            return 0;</span>
        }

<span class="fc" id="L94">        var tableColumn = this.tableAdjust.getColumnModel().getColumn(column);</span>
<span class="fc" id="L95">        Object value = tableColumn.getHeaderValue();</span>
<span class="fc" id="L96">        TableCellRenderer renderer = tableColumn.getHeaderRenderer();</span>
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">        if (renderer == null) {</span>
<span class="fc" id="L98">            renderer = this.tableAdjust.getTableHeader().getDefaultRenderer();</span>
        }

<span class="fc" id="L101">        var c = renderer.getTableCellRendererComponent(this.tableAdjust, value, false, false, -1, column);</span>
<span class="fc" id="L102">        return c.getPreferredSize().width;</span>
    }

    /**
     * Calculate the width based on the widest cell renderer for the
     * given column.
     */
    private int getColumnDataWidth(int column) {
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">        if (!this.isColumnDataIncluded) {</span>
<span class="nc" id="L111">            return 0;</span>
        }

<span class="fc" id="L114">        var preferredWidth = 0;</span>
<span class="fc" id="L115">        int maxWidth = this.tableAdjust.getColumnModel().getColumn(column).getMaxWidth();</span>

<span class="fc bfc" id="L117" title="All 2 branches covered.">        for (var row = 0 ; row &lt; this.tableAdjust.getRowCount() ; row++) {</span>
<span class="fc" id="L118">            preferredWidth = Math.max(preferredWidth, this.getCellDataWidth(row, column));</span>
            // We've exceeded the maximum width, no need to check other rows
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">            if (preferredWidth &gt;= maxWidth) {</span>
<span class="nc" id="L121">                break;</span>
            }
        }
<span class="fc" id="L124">        return preferredWidth;</span>
    }

    /**
     * Get the preferred width for the specified cell
     */
    private int getCellDataWidth(int row, int column) {
        // Invoke the renderer for the cell to calculate the preferred width
<span class="fc" id="L132">        TableCellRenderer cellRenderer = this.tableAdjust.getCellRenderer(row, column);</span>
<span class="fc" id="L133">        Component c = this.tableAdjust.prepareRenderer(cellRenderer, row, column);</span>
<span class="fc" id="L134">        return c.getPreferredSize().width + this.tableAdjust.getIntercellSpacing().width;</span>
    }

    /**
     * Update the TableColumn with the newly calculated width
     */
    private void updateTableColumn(int column, int width) {
<span class="fc" id="L141">        final var tableColumn = this.tableAdjust.getColumnModel().getColumn(column);</span>
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">        if (!tableColumn.getResizable()) {</span>
<span class="nc" id="L143">            return;</span>
        }

<span class="fc" id="L146">        int calculatedWidth = width;</span>
<span class="fc" id="L147">        calculatedWidth += this.spacing;</span>
        // Don't shrink the column width
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">        if (this.isOnlyAdjustLarger) {</span>
<span class="fc" id="L150">            calculatedWidth = Math.max(calculatedWidth, tableColumn.getPreferredWidth());</span>
        }

<span class="fc" id="L153">        this.columnSizes.put(tableColumn, tableColumn.getWidth());</span>
<span class="fc" id="L154">        this.tableAdjust.getTableHeader().setResizingColumn(tableColumn);</span>
<span class="fc" id="L155">        tableColumn.setWidth(calculatedWidth);</span>
<span class="fc" id="L156">    }</span>

    /**
     * Restore the widths of the columns in the table to its previous width
     */
    public void restoreColumns() {
<span class="nc" id="L162">        TableColumnModel tableColumnModel = this.tableAdjust.getColumnModel();</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">        for (var i = 0 ; i &lt; tableColumnModel.getColumnCount() ; i++) {</span>
<span class="nc" id="L164">            this.restoreColumn(i);</span>
        }
<span class="nc" id="L166">    }</span>

    /**
     * Restore the width of the specified column to its previous width
     */
    private void restoreColumn(int column) {
<span class="nc" id="L172">        var tableColumn = this.tableAdjust.getColumnModel().getColumn(column);</span>
<span class="nc" id="L173">        Integer width = this.columnSizes.get(tableColumn);</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (width != null) {</span>
<span class="nc" id="L175">            this.tableAdjust.getTableHeader().setResizingColumn(tableColumn);</span>
<span class="nc" id="L176">            tableColumn.setWidth(width);</span>
        }
<span class="nc" id="L178">    }</span>

    /**
     * Indicates whether to include the header in the width calculation
     */
    public void setColumnHeaderIncluded(boolean isColumnHeaderIncluded) {
<span class="fc" id="L184">        this.isColumnHeaderIncluded = isColumnHeaderIncluded;</span>
<span class="fc" id="L185">    }</span>

    /**
     * Indicates whether to include the model data in the width calculation
     */
    public void setColumnDataIncluded(boolean isColumnDataIncluded) {
<span class="fc" id="L191">        this.isColumnDataIncluded = isColumnDataIncluded;</span>
<span class="fc" id="L192">    }</span>

    /**
     * Indicates whether columns can only be increased in size
     */
    public void setOnlyAdjustLarger(boolean isOnlyAdjustLarger) {
<span class="fc" id="L198">        this.isOnlyAdjustLarger = isOnlyAdjustLarger;</span>
<span class="fc" id="L199">    }</span>

    /**
     * Indicate whether changes to the model should cause the width to be
     * dynamically recalculated.
     */
    public void setDynamicAdjustment(boolean isDynamicAdjustment) {
        // May need to add or remove the TableModelListener when changed
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">        if (this.isDynamicAdjustment != isDynamicAdjustment) {</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">            if (isDynamicAdjustment) {</span>
<span class="nc" id="L209">                this.tableAdjust.addPropertyChangeListener(this);</span>
<span class="nc" id="L210">                this.tableAdjust.getModel().addTableModelListener(this);</span>
            } else {
<span class="nc" id="L212">                this.tableAdjust.removePropertyChangeListener(this);</span>
<span class="nc" id="L213">                this.tableAdjust.getModel().removeTableModelListener(this);</span>
            }
        }
<span class="fc" id="L216">        this.isDynamicAdjustment = isDynamicAdjustment;</span>
<span class="fc" id="L217">    }</span>
    
    /**
     * Implement the PropertyChangeListener
     */
    @Override
    public void propertyChange(PropertyChangeEvent e) {
        // When the TableModel changes we need to update the listeners
        // and column widths
<span class="nc bnc" id="L226" title="All 2 branches missed.">        if (&quot;model&quot;.equals(e.getPropertyName())) {</span>
<span class="nc" id="L227">            TableModel model = (TableModel) e.getOldValue();</span>
<span class="nc" id="L228">            model.removeTableModelListener(this);</span>

<span class="nc" id="L230">            model = (TableModel) e.getNewValue();</span>
<span class="nc" id="L231">            model.addTableModelListener(this);</span>
<span class="nc" id="L232">            this.adjustColumns();</span>
        }
<span class="nc" id="L234">    }</span>
    
    /**
     * Implement the TableModelListener
     */
    @Override
    public void tableChanged(TableModelEvent e) {
<span class="nc bnc" id="L241" title="All 2 branches missed.">        if (!this.isColumnDataIncluded) {</span>
<span class="nc" id="L242">            return;</span>
        }

        // A cell has been updated
<span class="nc bnc" id="L246" title="All 2 branches missed.">        if (e.getType() == TableModelEvent.UPDATE) {</span>
<span class="nc" id="L247">            int column = this.tableAdjust.convertColumnIndexToView(e.getColumn());</span>

            // Only need to worry about an increase in width for this cell
<span class="nc bnc" id="L250" title="All 2 branches missed.">            if (this.isOnlyAdjustLarger) {</span>
<span class="nc" id="L251">                int row = e.getFirstRow();</span>
<span class="nc" id="L252">                var tableColumn = this.tableAdjust.getColumnModel().getColumn(column);</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">                if (tableColumn.getResizable()) {</span>
<span class="nc" id="L254">                    int width = this.getCellDataWidth(row, column);</span>
<span class="nc" id="L255">                    this.updateTableColumn(column, width);</span>
                }
<span class="nc" id="L257">            } else {</span>
<span class="nc" id="L258">                this.adjustColumn(column);  // Could be an increase of decrease so check all rows</span>
            }
<span class="nc" id="L260">        } else {</span>
<span class="nc" id="L261">            this.adjustColumns();  // The update affected more than one column so adjust all columns</span>
        }
<span class="nc" id="L263">    }</span>

    /**
     * Install Actions to give user control of certain functionality.
     */
    private void installActions() {
<span class="fc" id="L269">        this.installColumnAction(true,  true,  &quot;adjustColumn&quot;,   &quot;control ADD&quot;);</span>
<span class="fc" id="L270">        this.installColumnAction(false, true,  &quot;adjustColumns&quot;,  &quot;control shift ADD&quot;);</span>
<span class="fc" id="L271">        this.installColumnAction(true,  false, &quot;restoreColumn&quot;,  &quot;control SUBTRACT&quot;);</span>
<span class="fc" id="L272">        this.installColumnAction(false, false, &quot;restoreColumns&quot;, &quot;control shift SUBTRACT&quot;);</span>

<span class="fc" id="L274">        this.installToggleAction(true,  false, &quot;toggleDynamic&quot;,  &quot;control MULTIPLY&quot;);</span>
<span class="fc" id="L275">        this.installToggleAction(false, true,  &quot;toggleLarger&quot;,   &quot;control DIVIDE&quot;);</span>
<span class="fc" id="L276">    }</span>

    /**
     * Update the input and action maps with a new ColumnAction
     */
    private void installColumnAction(boolean isSelectedColumn, boolean isAdjust, String key, String keyStroke) {
<span class="fc" id="L282">        Action action = new ColumnAction(isSelectedColumn, isAdjust);</span>
<span class="fc" id="L283">        var ks = KeyStroke.getKeyStroke(keyStroke);</span>
        
<span class="fc" id="L285">        this.tableAdjust.getInputMap().put(ks, key);</span>
<span class="fc" id="L286">        this.tableAdjust.getActionMap().put(key, action);</span>
<span class="fc" id="L287">    }</span>

    /**
     * Update the input and action maps with new ToggleAction
     */
    private void installToggleAction(boolean isToggleDynamic, boolean isToggleLarger, String key, String keyStroke) {
<span class="fc" id="L293">        Action action = new ToggleAction(isToggleDynamic, isToggleLarger);</span>
<span class="fc" id="L294">        var ks = KeyStroke.getKeyStroke(keyStroke);</span>
        
<span class="fc" id="L296">        this.tableAdjust.getInputMap().put(ks, key);</span>
<span class="fc" id="L297">        this.tableAdjust.getActionMap().put(key, action);</span>
<span class="fc" id="L298">    }</span>

    /**
     * Action to adjust or restore the width of a single column or all columns
     */
    class ColumnAction extends AbstractAction {
        
        private final boolean isSelectedColumn;
        private final boolean isAdjust;

<span class="fc" id="L308">        public ColumnAction(boolean isSelectedColumn, boolean isAdjust) {</span>
<span class="fc" id="L309">            this.isSelectedColumn = isSelectedColumn;</span>
<span class="fc" id="L310">            this.isAdjust = isAdjust;</span>
<span class="fc" id="L311">        }</span>

        @Override
        public void actionPerformed(ActionEvent e) {
            // Handle selected column(s) width change actions
<span class="nc bnc" id="L316" title="All 2 branches missed.">            if (this.isSelectedColumn) {</span>
<span class="nc" id="L317">                int[] columns = AdjusterTableColumn.this.tableAdjust.getSelectedColumns();</span>

<span class="nc bnc" id="L319" title="All 2 branches missed.">                for (int column: columns) {</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">                    if (this.isAdjust) {</span>
<span class="nc" id="L321">                        AdjusterTableColumn.this.adjustColumn(column);</span>
                    } else {
<span class="nc" id="L323">                        AdjusterTableColumn.this.restoreColumn(column);</span>
                    }
                }
<span class="nc" id="L326">            } else {</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">                if (this.isAdjust) {</span>
<span class="nc" id="L328">                    AdjusterTableColumn.this.adjustColumns();</span>
                } else {
<span class="nc" id="L330">                    AdjusterTableColumn.this.restoreColumns();</span>
                }
            }
<span class="nc" id="L333">        }</span>
    }

    /**
     * Toggle properties of the TableColumnAdjuster so the user can
     * customize the functionality to their preferences
     */
    class ToggleAction extends AbstractAction {
        
        private final boolean isToggleDynamic;
        private final boolean isToggleLarger;

<span class="fc" id="L345">        public ToggleAction(boolean isToggleDynamic, boolean isToggleLarger) {</span>
<span class="fc" id="L346">            this.isToggleDynamic = isToggleDynamic;</span>
<span class="fc" id="L347">            this.isToggleLarger = isToggleLarger;</span>
<span class="fc" id="L348">        }</span>

        @Override
        public void actionPerformed(ActionEvent e) {
<span class="nc bnc" id="L352" title="All 2 branches missed.">            if (this.isToggleDynamic) {</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">                AdjusterTableColumn.this.setDynamicAdjustment(!AdjusterTableColumn.this.isDynamicAdjustment);</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">            } else if (this.isToggleLarger) {</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">                AdjusterTableColumn.this.setOnlyAdjustLarger(!AdjusterTableColumn.this.isOnlyAdjustLarger);</span>
            }
<span class="nc" id="L357">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>