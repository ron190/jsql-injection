<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MouseAdapterMenuAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">view</a> &gt; <a href="index.source.html" class="el_package">com.jsql.view.swing.list</a> &gt; <span class="el_source">MouseAdapterMenuAction.java</span></div><h1>MouseAdapterMenuAction.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Copyhacked (H) 2012-2025.
 * This program and the accompanying materials
 * are made available under no term at all, use it like
 * you want, but share and discuss it
 * every time possible with every body.
 * 
 * Contributors:
 *      ron190 at ymail dot com - initial implementation
 ******************************************************************************/
package com.jsql.view.swing.list;

import com.jsql.util.I18nUtil;
import com.jsql.util.LogLevelUtil;
import com.jsql.view.swing.util.I18nViewUtil;
import com.jsql.view.swing.util.MediatorHelper;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

import javax.swing.*;
import java.awt.*;
import java.awt.event.*;
import java.util.AbstractMap.SimpleEntry;
import java.util.Arrays;
import java.util.stream.Stream;

/**
 * A Mouse action to display a popupmenu on a JList.
 */
public class MouseAdapterMenuAction extends MouseAdapter {
    
    /**
     * Log4j logger sent to view.
     */
<span class="fc" id="L35">    private static final Logger LOGGER = LogManager.getRootLogger();</span>
    
    /**
     * JList to add popupmenu.
     */
    private final DnDList dndList;
    
    /**
     * Create a popup menu for current JList item.
     * @param dndList List with action
     */
<span class="fc" id="L46">    public MouseAdapterMenuAction(DnDList dndList) {</span>
<span class="fc" id="L47">        this.dndList = dndList;</span>
<span class="fc" id="L48">    }</span>
    
    /**
     * Displays a popup menu for JList.
     * @param mouseEvent Mouse event
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public void showPopup(final MouseEvent mouseEvent) {
<span class="fc bfc" id="L56" title="All 2 branches covered.">        if (mouseEvent.isPopupTrigger()) {</span>
<span class="fc" id="L57">            JList&lt;ItemList&gt; list = (JList&lt;ItemList&gt;) mouseEvent.getSource();</span>

<span class="fc" id="L59">            JPopupMenu popupMenuList = this.initMenu(mouseEvent);</span>
<span class="fc" id="L60">            popupMenuList.applyComponentOrientation(ComponentOrientation.getOrientation(I18nUtil.getCurrentLocale()));</span>
            // Fix #26274: IllegalComponentStateException on show()
            try {
<span class="fc" id="L63">                popupMenuList.show(</span>
                    list,
<span class="pc bpc" id="L65" title="1 of 2 branches missed.">                    ComponentOrientation.RIGHT_TO_LEFT.equals(ComponentOrientation.getOrientation(I18nUtil.getCurrentLocale()))</span>
<span class="nc" id="L66">                    ? mouseEvent.getX() - popupMenuList.getWidth()</span>
<span class="fc" id="L67">                    : mouseEvent.getX(),</span>
<span class="fc" id="L68">                    mouseEvent.getY()</span>
                );
<span class="nc" id="L70">            } catch (IllegalComponentStateException e) {</span>
<span class="nc" id="L71">                LOGGER.log(LogLevelUtil.CONSOLE_JAVA, e, e);</span>
<span class="fc" id="L72">            }</span>
            
<span class="fc" id="L74">            popupMenuList.setLocation(</span>
<span class="pc bpc" id="L75" title="1 of 2 branches missed.">                ComponentOrientation.RIGHT_TO_LEFT.equals(ComponentOrientation.getOrientation(I18nUtil.getCurrentLocale()))</span>
<span class="nc" id="L76">                ? mouseEvent.getXOnScreen() - popupMenuList.getWidth()</span>
<span class="fc" id="L77">                : mouseEvent.getXOnScreen(),</span>
<span class="fc" id="L78">                mouseEvent.getYOnScreen()</span>
            );
        }
<span class="fc" id="L81">    }</span>

    private JPopupMenu initMenu(final MouseEvent mouseEvent) {
<span class="fc" id="L84">        var popupMenuList = new JPopupMenu();</span>
        
<span class="fc" id="L86">        boolean isNonUbuntu = I18nViewUtil.isNonUbuntu(I18nUtil.getCurrentLocale());</span>
        
<span class="fc" id="L88">        JMenuItem menuImport = new JMenuItem();</span>
<span class="fc" id="L89">        JMenuItem menuExport = new JMenuItem();</span>
<span class="fc" id="L90">        JMenuItem menuCut = new JMenuItem();</span>
<span class="fc" id="L91">        JMenuItem menuCopy = new JMenuItem();</span>
<span class="fc" id="L92">        JMenuItem menuPaste = new JMenuItem();</span>
<span class="fc" id="L93">        JMenuItem menuDelete = new JMenuItem();</span>
<span class="fc" id="L94">        JMenuItem menuNew = new JMenuItem();</span>
<span class="fc" id="L95">        JMenuItem menuRestoreDefault = new JMenuItem();</span>
<span class="fc" id="L96">        JMenuItem menuSelectAll = new JMenuItem();</span>
        
<span class="fc" id="L98">        Stream.of(</span>
            new SimpleEntry&lt;&gt;(menuImport, &quot;LIST_IMPORT_CONFIRM_TITLE&quot;),
            new SimpleEntry&lt;&gt;(menuExport, &quot;LIST_EXPORT_TITLE&quot;),
            new SimpleEntry&lt;&gt;(menuCut, &quot;LIST_CUT&quot;),
            new SimpleEntry&lt;&gt;(menuCopy, &quot;CONTEXT_MENU_COPY&quot;),
            new SimpleEntry&lt;&gt;(menuPaste, &quot;LIST_PASTE&quot;),
            new SimpleEntry&lt;&gt;(menuDelete, &quot;LIST_DELETE&quot;),
            new SimpleEntry&lt;&gt;(menuNew, &quot;LIST_NEW_VALUE&quot;),
            new SimpleEntry&lt;&gt;(menuRestoreDefault, &quot;LIST_RESTORE_DEFAULT&quot;),
            new SimpleEntry&lt;&gt;(menuSelectAll, &quot;CONTEXT_MENU_SELECT_ALL&quot;)
        )
<span class="fc" id="L109">        .forEach(entry -&gt; {</span>
<span class="fc" id="L110">            entry.getKey().setText(</span>
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">                isNonUbuntu</span>
<span class="nc" id="L112">                ? I18nViewUtil.valueByKey(entry.getValue())</span>
<span class="fc" id="L113">                : I18nUtil.valueByKey(entry.getValue())</span>
            );
<span class="fc" id="L115">            entry.getKey().setName(entry.getValue());</span>
<span class="fc" id="L116">            I18nViewUtil.addComponentForKey(entry.getValue(), entry.getKey());</span>
<span class="fc" id="L117">        });</span>

<span class="fc" id="L119">        menuCut.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_X, InputEvent.CTRL_DOWN_MASK));</span>
<span class="fc" id="L120">        menuCopy.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_C, InputEvent.CTRL_DOWN_MASK));</span>
<span class="fc" id="L121">        menuPaste.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_V, InputEvent.CTRL_DOWN_MASK));</span>
<span class="fc" id="L122">        menuSelectAll.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_A, InputEvent.CTRL_DOWN_MASK));</span>
        
<span class="fc" id="L124">        final var importFileDialog = new JFileChooser(MediatorHelper.model().getMediatorUtils().getPreferencesUtil().getPathFile());</span>
<span class="fc" id="L125">        importFileDialog.setDialogTitle(I18nUtil.valueByKey(&quot;LIST_IMPORT_CONFIRM_TITLE&quot;));</span>
<span class="fc" id="L126">        importFileDialog.setMultiSelectionEnabled(true);</span>

<span class="fc" id="L128">        menuNew.addActionListener(new MenuActionNewValue(this.dndList));</span>

<span class="fc" id="L130">        menuImport.addActionListener(actionEvent -&gt; {</span>
<span class="nc" id="L131">            var choice = 0;</span>
            // Fix #1896: NullPointerException on showOpenDialog()
            // Fix #42831: ClassCastException on showOpenDialog()
            try {
<span class="nc" id="L135">                choice = importFileDialog.showOpenDialog(this.dndList.getTopLevelAncestor());</span>
<span class="nc" id="L136">            } catch (ClassCastException | NullPointerException e) {</span>
<span class="nc" id="L137">                LOGGER.log(LogLevelUtil.CONSOLE_JAVA, e, e);</span>
<span class="nc" id="L138">            }</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">            if (choice == JFileChooser.APPROVE_OPTION) {</span>
<span class="nc" id="L140">                this.dndList.dropPasteFile(</span>
<span class="nc" id="L141">                    Arrays.asList(importFileDialog.getSelectedFiles()),</span>
<span class="nc" id="L142">                    this.dndList.locationToIndex(mouseEvent.getPoint())</span>
                );
            }
<span class="nc" id="L145">        });</span>

<span class="fc" id="L147">        menuCopy.addActionListener(actionEvent -&gt; {</span>
<span class="nc" id="L148">            var action = this.dndList.getActionMap().get(TransferHandler.getCopyAction().getValue(Action.NAME));</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">            if (action != null) {</span>
<span class="nc" id="L150">                action.actionPerformed(</span>
                    new ActionEvent(this.dndList, ActionEvent.ACTION_PERFORMED, null)
                );
            }
<span class="nc" id="L154">        });</span>

<span class="fc" id="L156">        menuCut.addActionListener(actionEvent -&gt; {</span>
<span class="nc" id="L157">            var action = this.dndList.getActionMap().get(TransferHandler.getCutAction().getValue(Action.NAME));</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">            if (action != null) {</span>
<span class="nc" id="L159">                action.actionPerformed(</span>
                    new ActionEvent(this.dndList, ActionEvent.ACTION_PERFORMED, null)
                );
            }
<span class="nc" id="L163">        });</span>

<span class="fc" id="L165">        menuPaste.addActionListener(actionEvent -&gt; {</span>
<span class="nc" id="L166">            var action = this.dndList.getActionMap().get(TransferHandler.getPasteAction().getValue(Action.NAME));</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">            if (action != null) {</span>
<span class="nc" id="L168">                action.actionPerformed(</span>
                    new ActionEvent(this.dndList, ActionEvent.ACTION_PERFORMED, null)
                );
            }
<span class="nc" id="L172">        });</span>

<span class="pc" id="L174">        menuDelete.addActionListener(actionEvent -&gt; this.dndList.removeSelectedItem());</span>
<span class="fc" id="L175">        menuExport.addActionListener(new MenuActionExport(this.dndList));</span>
<span class="pc" id="L176">        menuRestoreDefault.addActionListener(actionEvent -&gt; this.dndList.restore());</span>
<span class="fc" id="L177">        menuSelectAll.addActionListener(actionEvent -&gt; {</span>
<span class="nc" id="L178">            var start = 0;</span>
<span class="nc" id="L179">            int end = this.dndList.getModel().getSize() - 1;</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">            if (end &gt;= 0) {</span>
<span class="nc" id="L181">                this.dndList.setSelectionInterval(start, end);</span>
            }
<span class="nc" id="L183">        });</span>

<span class="fc" id="L185">        popupMenuList.add(menuNew);</span>
<span class="fc" id="L186">        popupMenuList.add(new JSeparator());</span>
<span class="fc" id="L187">        popupMenuList.add(menuCut);</span>
<span class="fc" id="L188">        popupMenuList.add(menuCopy);</span>
<span class="fc" id="L189">        popupMenuList.add(menuPaste);</span>
<span class="fc" id="L190">        popupMenuList.add(menuDelete);</span>
<span class="fc" id="L191">        popupMenuList.add(new JSeparator());</span>
<span class="fc" id="L192">        popupMenuList.add(menuSelectAll);</span>
<span class="fc" id="L193">        popupMenuList.add(new JSeparator());</span>
<span class="fc" id="L194">        popupMenuList.add(menuImport);</span>
<span class="fc" id="L195">        popupMenuList.add(menuExport);</span>
<span class="fc" id="L196">        popupMenuList.add(new JSeparator());</span>
<span class="fc" id="L197">        popupMenuList.add(menuRestoreDefault);</span>
<span class="fc" id="L198">        return popupMenuList;</span>
    }

    @Override
    public void mousePressed(MouseEvent e) {
<span class="fc bfc" id="L203" title="All 2 branches covered.">        if (SwingUtilities.isRightMouseButton(e)) {</span>
<span class="fc" id="L204">            int clickIndex = this.dndList.locationToIndex(e.getPoint());</span>
<span class="fc" id="L205">            var containsIndex = false;</span>
<span class="pc bpc" id="L206" title="1 of 2 branches missed.">            for (int currentIndex: this.dndList.getSelectedIndices()) {</span>
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">                if (currentIndex == clickIndex) {</span>
<span class="fc" id="L208">                    containsIndex = true;</span>
<span class="fc" id="L209">                    break;</span>
                }
            }
<span class="pc bpc" id="L212" title="1 of 2 branches missed.">            if (!containsIndex) {</span>
<span class="nc" id="L213">                this.dndList.setSelectedIndex(clickIndex);</span>
            }
        }
<span class="fc" id="L216">        this.showPopup(e);</span>
<span class="fc" id="L217">    }</span>

    @Override
    public void mouseReleased(MouseEvent e) {
<span class="fc" id="L221">        this.showPopup(e);</span>
<span class="fc" id="L222">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>